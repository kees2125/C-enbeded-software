<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>tcps/tcps.c</h1>Simple TCP server.<p>
Program Ethernut with tcps.hex and enter<p>
<div class="fragment"><pre class="fragment"> telnet x.x.x.x 
</pre></div><p>
on a command prompt, replacing x.x.x.x with the IP address of your ethernut board. Enter help for a list of available commands.<p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * Copyright (C) 2001-2005 by egnite Software GmbH. All rights reserved.</span>
<span class="comment"> *</span>
<span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<span class="comment"> * modification, are permitted provided that the following conditions</span>
<span class="comment"> * are met:</span>
<span class="comment"> *</span>
<span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<span class="comment"> *    from this software without specific prior written permission.</span>
<span class="comment"> *</span>
<span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="comment"> * SUCH DAMAGE.</span>
<span class="comment"> *</span>
<span class="comment"> * For additional information see http://www.ethernut.de/</span>
<span class="comment"> *</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;cfg/os.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;io.h&gt;</span>

<span class="preprocessor">#include &lt;dev/board.h&gt;</span>

<span class="preprocessor">#include &lt;sys/version.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html">sys/heap.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html">sys/thread.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html">sys/timer.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html">sys/socket.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="inet_8h.html">arpa/inet.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="pro_2dhcp_8h.html">pro/dhcp.h</a>&gt;</span>

<span class="preprocessor">#ifdef NUTDEBUG</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/osdebug.h&gt;</span>
<span class="preprocessor">#include &lt;net/netdebug.h&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#include &lt;<a class="code" href="confnet_8h.html">sys/confnet.h</a>&gt;</span>

<span class="keyword">static</span> <span class="keywordtype">char</span> buff[128];

<span class="comment">/*</span>
<span class="comment"> * To save RAM, we store large strings in program space. With AVRGCC we</span>
<span class="comment"> * would be able to use the PSTR() macro and put the text directly in</span>
<span class="comment"> * the statement that uses it. But ICCAVR doesn't support anything like </span>
<span class="comment"> * this. Sigh.</span>
<span class="comment"> */</span>
<span class="preprocessor">#if defined(__IMAGECRAFT__)</span>
<span class="preprocessor"></span><span class="preprocessor">#define CC_STRING   "ICCAVR"</span>
<span class="preprocessor"></span><span class="preprocessor">#elif defined(__GNUC__)</span>
<span class="preprocessor"></span><span class="preprocessor">#define CC_STRING   "AVRGCC"</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#define CC_STRING   "Compiler unknown"</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
prog_char vbanner_P[] = <span class="stringliteral">"\n\nTCP Server Sample - Nut/OS %s - "</span> CC_STRING <span class="stringliteral">"\n"</span>;
prog_char banner_P[] = <span class="stringliteral">"200 Welcome to tcps. Type help to get help.\r\n"</span>;
prog_char help_P[] = <span class="stringliteral">"400 List of commands follows\r\n"</span>
    <span class="stringliteral">"m[emory]\tQueries number of RAM bytes free.\r\n"</span>
    <span class="stringliteral">"t[hreads]\tLists all created threads.\r\n"</span>
    <span class="stringliteral">"ti[mers]\tLists all running timers.\r\n"</span> <span class="stringliteral">"q[uit]\t\tTerminates connection.\r\n"</span> <span class="stringliteral">".\r\n"</span>;
prog_char thread_intro_P[] = <span class="stringliteral">"220 List of threads with name,state,prio,stack,mem,timeout follows\r\n"</span>;
prog_char timer_intro_P[] = <span class="stringliteral">"221 List of timers with ticks left and interval follows\r\n"</span>;
prog_char mem_fmt_P[] = <span class="stringliteral">"210 %u bytes RAM free\r\n"</span>;

<span class="comment">/*</span>
<span class="comment"> * Process client requests.</span>
<span class="comment"> */</span>
<span class="keywordtype">void</span> ProcessRequests(<a name="a397"></a><a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> * stream)
{
    <span class="keywordtype">int</span> got;
    <span class="keywordtype">char</span> *cp;

    <span class="comment">/*</span>
<span class="comment">     * Send a welcome banner.</span>
<span class="comment">     */</span>
    <a name="a398"></a><a class="code" href="group__xgCrtStdio.html#ga23">fputs_P</a>(banner_P, stream);
    <span class="keywordflow">for</span> (;;) {

        <span class="comment">/*</span>
<span class="comment">         * Flush output and read a line.</span>
<span class="comment">         */</span>
        <a name="a399"></a><a class="code" href="group__xgCrtStdio.html#ga11">fflush</a>(stream);
        <span class="keywordflow">if</span> (<a name="a400"></a><a class="code" href="group__xgCrtStdio.html#ga13">fgets</a>(buff, <span class="keyword">sizeof</span>(buff), stream) == 0)
            <span class="keywordflow">break</span>;

        <span class="comment">/*</span>
<span class="comment">         * Chop off EOL.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> ((cp = <a name="a401"></a><a class="code" href="group__xgCrtString.html#ga8">strchr</a>(buff, <span class="charliteral">'\r'</span>)) != 0)
            *cp = 0;
        <span class="keywordflow">if</span> ((cp = <a class="code" href="group__xgCrtString.html#ga8">strchr</a>(buff, <span class="charliteral">'\n'</span>)) != 0)
            *cp = 0;

        <span class="comment">/*</span>
<span class="comment">         * Ignore blank lines.</span>
<span class="comment">         */</span>
        got = <a name="a402"></a><a class="code" href="group__xgCrtString.html#ga14">strlen</a>(buff);
        <span class="keywordflow">if</span> (got == 0)
            <span class="keywordflow">continue</span>;

        <span class="comment">/*</span>
<span class="comment">         * Memory info.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a name="a403"></a><a class="code" href="group__xgCrtString.html#ga16">strncmp</a>(buff, <span class="stringliteral">"memory"</span>, got) == 0) {
            <a name="a404"></a><a class="code" href="group__xgCrtStdio.html#ga19">fprintf_P</a>(stream, mem_fmt_P, (<a name="a405"></a><a class="code" href="group__xgNutOS.html#ga2">u_int</a>)<a name="a406"></a><a class="code" href="group__xgHeap.html#ga8">NutHeapAvailable</a>());
            <span class="keywordflow">continue</span>;
        }

        <span class="comment">/*</span>
<span class="comment">         * List threads.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a class="code" href="group__xgCrtString.html#ga16">strncmp</a>(buff, <span class="stringliteral">"threads"</span>, got) == 0) {
            <a name="_a407"></a><a class="code" href="struct__NUTTHREADINFO.html">NUTTHREADINFO</a> *tdp;
            <a name="_a408"></a><a class="code" href="struct__NUTTIMERINFO.html">NUTTIMERINFO</a> *tnp;

            <a class="code" href="group__xgCrtStdio.html#ga23">fputs_P</a>(thread_intro_P, stream);
            <span class="keywordflow">for</span> (tdp = <a name="a409"></a><a class="code" href="group__xgThread.html#ga3">nutThreadList</a>; tdp; tdp = tdp-&gt;<a name="a410"></a><a class="code" href="struct__NUTTHREADINFO.html#o0">td_next</a>) {
                <a name="a411"></a><a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(tdp-&gt;<a name="a412"></a><a class="code" href="struct__NUTTHREADINFO.html#o3">td_name</a>, stream);
                <span class="keywordflow">switch</span> (tdp-&gt;<a name="a413"></a><a class="code" href="struct__NUTTHREADINFO.html#o4">td_state</a>) {
                <span class="keywordflow">case</span> <a name="a414"></a><a class="code" href="thread_8h.html#a1">TDS_TERM</a>:
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tTerm\t"</span>, stream);
                    <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <a name="a415"></a><a class="code" href="thread_8h.html#a2">TDS_RUNNING</a>:
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tRun\t"</span>, stream);
                    <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <a name="a416"></a><a class="code" href="thread_8h.html#a3">TDS_READY</a>:
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tReady\t"</span>, stream);
                    <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <a name="a417"></a><a class="code" href="thread_8h.html#a4">TDS_SLEEP</a>:
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tSleep\t"</span>, stream);
                    <span class="keywordflow">break</span>;
                }
                <a name="a418"></a><a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(stream, <span class="stringliteral">"%u\t%u"</span>, tdp-&gt;<a name="a419"></a><a class="code" href="struct__NUTTHREADINFO.html#o6">td_priority</a>, (<a class="code" href="group__xgNutOS.html#ga2">u_int</a>) tdp-&gt;<a name="a420"></a><a class="code" href="struct__NUTTHREADINFO.html#o5">td_sp</a> - (<a class="code" href="group__xgNutOS.html#ga2">u_int</a>) tdp-&gt;<a name="a421"></a><a class="code" href="struct__NUTTHREADINFO.html#o7">td_memory</a>);
                <span class="keywordflow">if</span> (*((<a name="a422"></a><a class="code" href="group__xgNutOS.html#ga3">u_long</a> *) tdp-&gt;<a class="code" href="struct__NUTTHREADINFO.html#o7">td_memory</a>) != DEADBEEF)
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tCorrupted\t"</span>, stream);
                <span class="keywordflow">else</span>
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tOK\t"</span>, stream);

                <span class="keywordflow">if</span> ((tnp = (<a class="code" href="struct__NUTTIMERINFO.html">NUTTIMERINFO</a> *) tdp-&gt;<a name="a423"></a><a class="code" href="struct__NUTTHREADINFO.html#o8">td_timer</a>) != 0)
                    <a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(stream, <span class="stringliteral">"%lu\r\n"</span>, tnp-&gt;<a name="a424"></a><a class="code" href="struct__NUTTIMERINFO.html#o3">tn_ticks_left</a>);
                <span class="keywordflow">else</span>
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"None\r\n"</span>, stream);
            }
            <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">".\r\n"</span>, stream);
            <span class="keywordflow">continue</span>;
        }

        <span class="comment">/*</span>
<span class="comment">         * List timers.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a class="code" href="group__xgCrtString.html#ga16">strncmp</a>(<span class="stringliteral">"timers"</span>, buff, got) == 0) {
            <a class="code" href="struct__NUTTIMERINFO.html">NUTTIMERINFO</a> *tnp;

            <a class="code" href="group__xgCrtStdio.html#ga23">fputs_P</a>(timer_intro_P, stream);
            <span class="keywordflow">for</span> (tnp = <a name="a425"></a><a class="code" href="group__xgTimer.html#ga0">nutTimerList</a>; tnp; tnp = tnp-&gt;<a name="a426"></a><a class="code" href="struct__NUTTIMERINFO.html#o0">tn_next</a>) {
                <a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(stream, <span class="stringliteral">"%lu\t"</span>, tnp-&gt;<a class="code" href="struct__NUTTIMERINFO.html#o3">tn_ticks_left</a>);
                <span class="keywordflow">if</span> (tnp-&gt;<a name="a427"></a><a class="code" href="struct__NUTTIMERINFO.html#o2">tn_ticks</a>)
                    <a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(stream, <span class="stringliteral">"%lu\r\n"</span>, tnp-&gt;<a class="code" href="struct__NUTTIMERINFO.html#o2">tn_ticks</a>);
                <span class="keywordflow">else</span>
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"Oneshot\r\n"</span>, stream);
            }
            <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">".\r\n"</span>, stream);
            <span class="keywordflow">continue</span>;
        }

        <span class="comment">/*</span>
<span class="comment">         * Quit connection.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a class="code" href="group__xgCrtString.html#ga16">strncmp</a>(<span class="stringliteral">"quit"</span>, buff, got) == 0) {
            <span class="keywordflow">break</span>;
        }

        <span class="comment">/*</span>
<span class="comment">         * Display help text on any unknown command.</span>
<span class="comment">         */</span>
        <a class="code" href="group__xgCrtStdio.html#ga23">fputs_P</a>(help_P, stream);
    }
}

<span class="comment">/*</span>
<span class="comment"> * Main application routine. </span>
<span class="comment"> *</span>
<span class="comment"> * Nut/OS automatically calls this entry after initialization.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
    <a name="_a428"></a><a class="code" href="structtcp__socket.html">TCPSOCKET</a> *sock;
    <a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> *stream;
    <a class="code" href="group__xgNutOS.html#ga3">u_long</a> baud = 115200;
    <a name="a429"></a><a class="code" href="group__xgNutOS.html#ga0">u_char</a> mac[6] = { 0x00, 0x06, 0x98, 0x00, 0x00, 0x55 };

    <span class="comment">/*</span>
<span class="comment">     * Register all devices used in our application.</span>
<span class="comment">     */</span>
    <a name="a430"></a><a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_DEBUG, 0, 0);
    <a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_ETHER, 0x8300, 5);

    <span class="comment">/*</span>
<span class="comment">     * Assign stdout to the UART device.</span>
<span class="comment">     */</span>
    <a name="a431"></a><a class="code" href="group__xgCrtStdio.html#ga25">freopen</a>(DEV_DEBUG_NAME, <span class="stringliteral">"w"</span>, <a name="a432"></a><a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>);
    <a name="a433"></a><a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(<a name="a434"></a><a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>), <a name="a435"></a><a class="code" href="group__xgUARTIOCTL.html#ga0">UART_SETSPEED</a>, &amp;baud);
    <a name="a436"></a><a class="code" href="group__xgCrtStdio.html#ga37">printf_P</a>(vbanner_P, <a name="a437"></a><a class="code" href="group__xgNutVersion.html#ga1">NutVersionString</a>());
<span class="preprocessor">#ifdef NUTDEBUG</span>
<span class="preprocessor"></span>    NutTraceTcp(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>, 1);
    NutTraceOs(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>, 0);
    NutTraceHeap(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>, 0);
    NutTracePPP(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>, 0);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <a name="a438"></a><a class="code" href="group__xgConfNet.html#ga3">NutNetLoadConfig</a>(DEV_ETHER_NAME);
    memcpy(<a name="a439"></a><a class="code" href="group__xgConfNet.html#ga1">confnet</a>.<a name="a440"></a><a class="code" href="struct__CONFNET.html#o2">cdn_mac</a>, mac, 6);
    <a name="a441"></a><a class="code" href="group__xgConfNet.html#ga4">NutNetSaveConfig</a>();

    <span class="comment">/*</span>
<span class="comment">     * Setup the ethernet device. Try DHCP first. If this is</span>
<span class="comment">     * the first time boot with empty EEPROM and no DHCP server</span>
<span class="comment">     * was found, use hardcoded values.</span>
<span class="comment">     */</span>
    <a name="a442"></a><a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Configure eth0..."</span>);
    <span class="keywordflow">if</span> (<a name="a443"></a><a class="code" href="pro_2dhcp_8h.html#a17">NutDhcpIfConfig</a>(<span class="stringliteral">"eth0"</span>, 0, 60000)) {
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"initial boot..."</span>);
        <span class="keywordflow">if</span> (<a class="code" href="pro_2dhcp_8h.html#a17">NutDhcpIfConfig</a>(<span class="stringliteral">"eth0"</span>, mac, 60000)) {
            <a class="code" href="group__xgNutOS.html#ga3">u_long</a> ip_addr = <a name="a444"></a><a class="code" href="group__xgIP.html#ga8">inet_addr</a>(<span class="stringliteral">"192.168.192.100"</span>);
            <a class="code" href="group__xgNutOS.html#ga3">u_long</a> ip_mask = <a class="code" href="group__xgIP.html#ga8">inet_addr</a>(<span class="stringliteral">"255.255.255.0"</span>);

            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"no DHCP..."</span>);
            <a name="a445"></a><a class="code" href="group__xgIP.html#ga6">NutNetIfConfig</a>(<span class="stringliteral">"eth0"</span>, mac, ip_addr, ip_mask);
            <span class="comment">/* If not in a local network, we must also call </span>
<span class="comment">               NutIpRouteAdd() to configure the routing. */</span>
        }
    }
    <a name="a446"></a><a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"OK"</span>);
    <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"IP: %s\n"</span>, <a name="a447"></a><a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(<a class="code" href="group__xgConfNet.html#ga1">confnet</a>.<a name="a448"></a><a class="code" href="struct__CONFNET.html#o3">cdn_ip_addr</a>));

    <span class="comment">/*</span>
<span class="comment">     * Now loop endless for connections.</span>
<span class="comment">     */</span>
    <span class="keywordflow">for</span> (;;) {
        <span class="comment">/*</span>
<span class="comment">         * Create a socket.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> ((sock = <a name="a449"></a><a class="code" href="group__xgTcpSocket.html#ga7">NutTcpCreateSocket</a>()) != 0) {
            <span class="comment">/*</span>
<span class="comment">             * Listen on port 23. If we return, we got a client.</span>
<span class="comment">             */</span>
            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Waiting for a telnet client..."</span>);
            <span class="keywordflow">if</span> (<a name="a450"></a><a class="code" href="group__xgTcpSocket.html#ga11">NutTcpAccept</a>(sock, 23) == 0) {
                <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"connected"</span>);

                <span class="comment">/*</span>
<span class="comment">                 * Open a stream and associate it with the socket, so </span>
<span class="comment">                 * we can use standard I/O. Note, that socket streams</span>
<span class="comment">                 * currently do support text mode.</span>
<span class="comment">                 */</span>
                <span class="keywordflow">if</span> ((stream = <a name="a451"></a><a class="code" href="group__xgCrtStdio.html#ga8">_fdopen</a>((<span class="keywordtype">int</span>) sock, <span class="stringliteral">"r+b"</span>)) != 0) {
                    <span class="comment">/*</span>
<span class="comment">                     * Process client requests.</span>
<span class="comment">                     */</span>
                    ProcessRequests(stream);
                    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Disconnected"</span>);

                    <span class="comment">/*</span>
<span class="comment">                     * Close the stream.</span>
<span class="comment">                     */</span>
                    <a name="a452"></a><a class="code" href="group__xgCrtStdio.html#ga6">fclose</a>(stream);
                } <span class="keywordflow">else</span>
                    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Assigning a stream failed"</span>);
            } <span class="keywordflow">else</span>
                <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"failed"</span>);

            <span class="comment">/*</span>
<span class="comment">             * Close our socket.</span>
<span class="comment">             */</span>
            <a name="a453"></a><a class="code" href="group__xgTcpSocket.html#ga14">NutTcpCloseSocket</a>(sock);
        }
    }
}
</pre></div> <hr>
<address>
  <small>
    &copy;&nbsp;2000-2006 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
