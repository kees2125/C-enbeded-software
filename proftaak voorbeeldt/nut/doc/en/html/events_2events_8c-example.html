<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>events/events.c</h1>This sample demonstrates the usage of Nut/OS event queues. It further shows how an event queue can be used as a mutual exclusion semaphore.<p>
Two additional threads are started, one with a higher and another one with a lower priority than the main thread.<p>
The results are printed on the debug device. Each thread prints the current action in one of three columns. The first column is used by the highest priority, the last column by the lowest priority thread.<p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;cfg/os.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;io.h&gt;</span>

<span class="preprocessor">#include &lt;dev/board.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html">sys/thread.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html">sys/timer.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="event_8h.html">sys/event.h</a>&gt;</span>

<span class="comment">/*</span>
<span class="comment"> * A global event queue, used as a mutex semaphore.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <a name="a10"></a><a class="code" href="group__xgNutOS.html#ga5">HANDLE</a> mutex;

<span class="comment">/*</span>
<span class="comment"> * High priority background thread. </span>
<span class="comment"> */</span>
<a name="a11"></a><a class="code" href="thread_8h.html#a6">THREAD</a>(High, arg)
{
    <a name="a12"></a><a class="code" href="group__xgThread.html#ga10">NutThreadSetPriority</a>(32);
    <span class="keywordflow">for</span>(;;) {
        <a name="a13"></a><a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Request"</span>);
        <span class="keywordflow">if</span> (<a name="a14"></a><a class="code" href="group__xgEvent.html#ga1">NutEventWait</a>(&amp;mutex, 2000)) {
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Timeout"</span>);
        }
        <span class="keywordflow">else</span> {
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Acquired"</span>);
            <a name="a15"></a><a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(2500);
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Release"</span>);
            <a name="a16"></a><a class="code" href="group__xgEvent.html#ga4">NutEventPost</a>(&amp;mutex);
        }
        <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1000);
    }
}

<span class="comment">/*</span>
<span class="comment"> * Low priority background thread. </span>
<span class="comment"> */</span>
<a class="code" href="thread_8h.html#a6">THREAD</a>(Low, arg)
{
    <a class="code" href="group__xgThread.html#ga10">NutThreadSetPriority</a>(96);
    <span class="keywordflow">for</span>(;;) {
        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"                  Request"</span>);
        <span class="keywordflow">if</span> (<a class="code" href="group__xgEvent.html#ga1">NutEventWait</a>(&amp;mutex, 3000)) {
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"                  Timeout"</span>);
        }
        <span class="keywordflow">else</span> {
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"                  Acquired"</span>);
            <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(3500);
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"                  Release"</span>);
            <a class="code" href="group__xgEvent.html#ga4">NutEventPost</a>(&amp;mutex);
        }
    }
}

<span class="comment">/*</span>
<span class="comment"> * Main application routine. </span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
    <a name="a17"></a><a class="code" href="group__xgNutOS.html#ga3">u_long</a> baud = 115200;

    <span class="comment">/*</span>
<span class="comment">     * Register the UART device, open it, assign stdout to it and set </span>
<span class="comment">     * the baudrate.</span>
<span class="comment">     */</span>
    <a name="a18"></a><a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_DEBUG, 0, 0);
    <a name="a19"></a><a class="code" href="group__xgCrtStdio.html#ga25">freopen</a>(DEV_DEBUG_NAME, <span class="stringliteral">"w"</span>, <a name="a20"></a><a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>);
    <a name="a21"></a><a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(<a name="a22"></a><a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>), <a name="a23"></a><a class="code" href="group__xgUARTIOCTL.html#ga0">UART_SETSPEED</a>, &amp;baud);

    <span class="comment">/*</span>
<span class="comment">     * Print title.</span>
<span class="comment">     */</span>
    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"\nNut/OS Event Queue Demo"</span>);
    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"High     Main     Low      "</span>);

    <span class="comment">/*</span>
<span class="comment">     * Post an initial event. This will put the queue into signaled </span>
<span class="comment">     * state and immediately grant the next call to NutEventWait().</span>
<span class="comment">     */</span>
    <a class="code" href="group__xgEvent.html#ga4">NutEventPost</a>(&amp;mutex);

    <span class="comment">/*</span>
<span class="comment">     * Start two background threads.</span>
<span class="comment">     */</span>
    <a name="a24"></a><a class="code" href="group__xgNutArchAvrOsContextGcc.html#ga2">NutThreadCreate</a>(<span class="stringliteral">"high"</span>, High, 0, 256);
    <a class="code" href="group__xgNutArchAvrOsContextGcc.html#ga2">NutThreadCreate</a>(<span class="stringliteral">"low"</span>, Low, 0, 256);

    <span class="keywordflow">for</span>(;;) {
        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"         Request"</span>);
        <span class="keywordflow">if</span> (<a class="code" href="group__xgEvent.html#ga1">NutEventWait</a>(&amp;mutex, 1000)) {
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"         Timeout"</span>);
        }
        <span class="keywordflow">else</span> {
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"         Acquired"</span>);
            <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1500);
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"         Release"</span>);
            <a class="code" href="group__xgEvent.html#ga4">NutEventPost</a>(&amp;mutex);
        }
        <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1000);
    }
}
</pre></div> <hr>
<address>
  <small>
    &copy;&nbsp;2000-2006 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
