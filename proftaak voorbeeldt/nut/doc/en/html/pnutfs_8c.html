<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">ethernut-4.3.3</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_000001.html">nut</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_000032.html">fs</a></div>
<h1>pnutfs.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
Peanut File System. 
<p>
<div class="fragment"><pre class="fragment"> *
 * $Log: pnutfs.c,v $
 * Revision 1.10  2006/08/01 07:43:48  haraldkipp
 * PNUT file system failed after some modifications done previously for the
 * PHAT file system. During directory open, the NUTFILE structure must be
 * allocated in the file system driver. PnutDirRead() must return -1 if the
 * end of a directory is reached. Reading unused directory entries must update
 * the file position pointer.
 *
 * Revision 1.9  2006/03/02 20:01:17  haraldkipp
 * Added implementation of dev_size makes _filelength() work, which in turn
 * enables the use of this file system in pro/httpd.c.
 *
 * Revision 1.8  2006/01/05 16:45:20  haraldkipp
 * Dynamic NUTFILE allocation for detached block device.
 *
 * Revision 1.7  2005/09/08 10:12:44  olereinhardt
 * Added #ifdef statement in NutSegBufEnable to avoid compiler warning
 * if no banked mem is used.
 *
 * Revision 1.6  2005/09/07 16:23:41  christianwelzel
 * Added support for MMnet02. Bankswitching is now handled in bankmem.h
 *
 * Revision 1.5  2005/08/02 17:46:47  haraldkipp
 * Major API documentation update.
 *
 * Revision 1.4  2005/05/16 08:33:59  haraldkipp
 * Added banking support for Arthernet.
 *
 * Revision 1.3  2005/02/21 11:10:21  olereinhardt
 * Changed deckaration of the "root" variable to compile with unix emulation
 *
 * Revision 1.2  2005/02/07 18:57:47  haraldkipp
 * ICCAVR compile errors fixed
 *
 * Revision 1.1  2005/02/05 20:35:21  haraldkipp
 * Peanut added
 *
 * </pre></div>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structPNUT__NODE.html">PNUT_NODE</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Node structure.  <a href="structPNUT__NODE.html#_details">More...</a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structPNUT__DIRENTRY.html">PNUT_DIRENTRY</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Directory entry structure.  <a href="structPNUT__DIRENTRY.html#_details">More...</a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structPNUT__FINDRESULT.html">PNUT_FINDRESULT</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Directory search result information structure.  <a href="structPNUT__FINDRESULT.html#_details">More...</a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct__PNUTFILE.html">_PNUTFILE</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">PNUT file descriptor structure.  <a href="struct__PNUTFILE.html#_details">More...</a><br></td></tr>
<tr><td colspan="2"><br><h2>Peanut File System Configuration</h2></td></tr>
<tr><td colspan="2">The Nut/OS Configurator may be used to override the default values. <br><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a0"></a><!-- doxytag: member="pnutfs.c::PNUT_BLOCK_SIZE" ref="a0" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a0">PNUT_BLOCK_SIZE</a>&nbsp;&nbsp;&nbsp;512</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Size of a filesystem block. <br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a1"></a><!-- doxytag: member="pnutfs.c::PNUT_DIRENT_SIZE" ref="a1" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a1">PNUT_DIRENT_SIZE</a>&nbsp;&nbsp;&nbsp;32</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Size of a directory entry. <br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a2">PNUT_BLOCKS_PER_NODE</a>&nbsp;&nbsp;&nbsp;250</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Maximum number of blocks per node.  <a href="#a2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a3"></a><!-- doxytag: member="pnutfs.c::PNUTBANK_COUNT" ref="a3" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>PNUTBANK_COUNT</b>&nbsp;&nbsp;&nbsp;30</td></tr>

<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a4"></a><!-- doxytag: member="pnutfs.c::SEEK_SET" ref="a4" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>SEEK_SET</b>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a5"></a><!-- doxytag: member="pnutfs.c::SEEK_CUR" ref="a5" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>SEEK_CUR</b>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a6"></a><!-- doxytag: member="pnutfs.c::SEEK_END" ref="a6" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>SEEK_END</b>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a7"></a><!-- doxytag: member="pnutfs.c::NODETYPE_REG" ref="a7" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>NODETYPE_REG</b>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a8"></a><!-- doxytag: member="pnutfs.c::NODETYPE_DIR" ref="a8" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>NODETYPE_DIR</b>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a9">PNUT_MAX_NAMELEN</a>&nbsp;&nbsp;&nbsp;(PNUT_DIRENT_SIZE - sizeof(PNUT_BLKNUM) - sizeof(u_char) - 1)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Maximum length of a base name.  <a href="#a9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a10">PNUT_MAX_FILESIZE</a>&nbsp;&nbsp;&nbsp;(PNUT_BLOCKS_PER_NODE * PNUT_BLOCK_SIZE)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Maximum size of a file or directory.  <a href="#a10"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a11"></a><!-- doxytag: member="pnutfs.c::NUTBANK_SIZE" ref="a11" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a11">NUTBANK_SIZE</a>&nbsp;&nbsp;&nbsp;16384</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Size of each memory bank. <br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a12">PNUT_TOTAL_BLOCKS</a>&nbsp;&nbsp;&nbsp;(PNUTBANK_COUNT * (NUTBANK_SIZE / PNUT_BLOCK_SIZE))</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Total number of blocks on this device.  <a href="#a12"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a13"></a><!-- doxytag: member="pnutfs.c::BLOCKS_PER_BANK" ref="a13" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>BLOCKS_PER_BANK</b>&nbsp;&nbsp;&nbsp;(NUTBANK_SIZE / PNUT_BLOCK_SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a14"></a><!-- doxytag: member="pnutfs.c::NUTBANK_SR" ref="a14" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>NUTBANK_SR</b>&nbsp;&nbsp;&nbsp;0xFF00</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a15"></a><!-- doxytag: member="pnutfs.c::NUTBANK_START" ref="a15" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>NUTBANK_START</b>&nbsp;&nbsp;&nbsp;0x8000</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a16"></a><!-- doxytag: member="pnutfs.c::NUTBANK_PTR" ref="a16" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>NUTBANK_PTR</b>&nbsp;&nbsp;&nbsp;((char *)NUTBANK_START)</td></tr>

<tr><td colspan="2"><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a17"></a><!-- doxytag: member="pnutfs.c::PNUT_BLKNUM" ref="a17" args="" -->
typedef short&nbsp;</td><td class="memItemRight" valign="bottom"><b>PNUT_BLKNUM</b></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a18"></a><!-- doxytag: member="pnutfs.c::PNUTFILE" ref="a18" args="" -->
typedef <a class="el" href="struct__PNUTFILE.html">_PNUTFILE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a18">PNUTFILE</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">PNUT file descriptor type. <br></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a22">BankSelect</a> (PNUT_BLKNUM blk)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Make the bank visible, which contains the specified block.  <a href="#a22"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a23"></a><!-- doxytag: member="pnutfs.c::BankNodePointer" ref="a23" args="(PNUT_BLKNUM blk)" -->
<a class="el" href="structPNUT__NODE.html">PNUT_NODE</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a23">BankNodePointer</a> (PNUT_BLKNUM blk)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Select specified bank and return pointer to block. <br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a48"></a><!-- doxytag: member="pnutfs.c::PnutIOCtl" ref="a48" args="(NUTDEVICE *dev, int req, void *conf)" -->
int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a48">PnutIOCtl</a> (<a class="el" href="struct__NUTDEVICE.html">NUTDEVICE</a> *dev, int req, void *conf)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Device specific functions. <br></td></tr>
<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="struct__NUTDEVICE.html">NUTDEVICE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pnutfs_8c.html#a21">devPnut</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Peanut device information structure.  <a href="#a21"></a><br></td></tr>
</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2"></a><!-- doxytag: member="pnutfs.c::PNUT_BLOCKS_PER_NODE" ref="a2" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define PNUT_BLOCKS_PER_NODE&nbsp;&nbsp;&nbsp;250          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Maximum number of blocks per node. 
<p>
Peanut supports only one node per file. Thus, this number multiplied by PNUT_BLOCK_SIZE specifies the maximum file size.<p>
Changings this number will change the size of the node structure, which must fit into a single filesystem block.    </td>
  </tr>
</table>
<a class="anchor" name="a9"></a><!-- doxytag: member="pnutfs.c::PNUT_MAX_NAMELEN" ref="a9" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define PNUT_MAX_NAMELEN&nbsp;&nbsp;&nbsp;(PNUT_DIRENT_SIZE - sizeof(PNUT_BLKNUM) - sizeof(u_char) - 1)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Maximum length of a base name. 
<p>
This is a calculated value and depends on the definition of the block size and the size of a directory entry.    </td>
  </tr>
</table>
<a class="anchor" name="a10"></a><!-- doxytag: member="pnutfs.c::PNUT_MAX_FILESIZE" ref="a10" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define PNUT_MAX_FILESIZE&nbsp;&nbsp;&nbsp;(PNUT_BLOCKS_PER_NODE * PNUT_BLOCK_SIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Maximum size of a file or directory. 
<p>
This is a calculated value and depends on the definition of the block size and the number of blocks per directory entry.    </td>
  </tr>
</table>
<a class="anchor" name="a12"></a><!-- doxytag: member="pnutfs.c::PNUT_TOTAL_BLOCKS" ref="a12" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">#define PNUT_TOTAL_BLOCKS&nbsp;&nbsp;&nbsp;(PNUTBANK_COUNT * (NUTBANK_SIZE / PNUT_BLOCK_SIZE))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Total number of blocks on this device. 
<p>
This value is calulated by multiplying the number of memory banks reserved for the file system by the number of blocks per bank.<p>
For example, if all 30 banks, which are available on Ethernut 2, are reserved for PNUT and if the size of a block is 512 bytes, then 960 blocks are available.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a22"></a><!-- doxytag: member="pnutfs.c::BankSelect" ref="a22" args="(PNUT_BLKNUM blk)" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void BankSelect           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PNUT_BLKNUM&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>blk</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Make the bank visible, which contains the specified block. 
<p>
On Ethernut 2 we select a bank by writing the bank number to the bank register base address plus the bank number.<p>
For example, writing 0x12 to 0xFF12 selects bank 18 (0x12), assuming that 0xFF00 is the bank register base address.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>blk</em>&nbsp;</td><td>Block number to access.</td></tr>
  </table>
</dl>
    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a21"></a><!-- doxytag: member="pnutfs.c::devPnut" ref="a21" args="" --><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="struct__NUTDEVICE.html">NUTDEVICE</a> <a class="el" href="pnutfs_8c.html#a21">devPnut</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
    0,                          
    {<span class="charliteral">'P'</span>, <span class="charliteral">'N'</span>, <span class="charliteral">'U'</span>, <span class="charliteral">'T'</span>, 0, 0, 0, 0, 0}
    ,                           
    <a class="code" href="group__xgDevice.html#ga14">IFTYP_RAM</a>,                  
    0,                          
    0,                          
    0,                          
    0,                          
    PnutInit,                   
    <a class="code" href="pnutfs_8c.html#a48">PnutIOCtl</a>,                  
    PnutFileRead,               
    PnutFileWrite,              

    PnutFileWrite_P,            

    PnutFileOpen,               
    PnutFileClose,              
    PnutFileSize                
}
</pre></div>Peanut device information structure. 
<p>
<dl compact><dt><b>Log</b></dt><dd>pnut.h,v </dd></dl>
Revision 1.1 2005/02/05 20:37:17 haraldkipp Peanut added    </td>
  </tr>
</table>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2006 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
