<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>rs232d/rs232d.c</h1>Simple RS232 server. Use a serial cable to connect the RS232 port of the Ethernut Board with a COM port of a PC. Start a terminal program and a telnet client on the PC. Telnet should connect to the Ethernut Board.<p>
Characters typed in the telnet window will appear in the terminal program window and vice versa. Baudrate is 9600.<p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;dev/board.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html">sys/heap.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html">sys/thread.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html">sys/timer.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html">sys/socket.h</a>&gt;</span>

<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;io.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html">fcntl.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="inet_8h.html">arpa/inet.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="pro_2dhcp_8h.html">pro/dhcp.h</a>&gt;</span>

<span class="preprocessor">#define BUFFERSIZE  128</span>
<span class="preprocessor"></span><span class="preprocessor">#define TCPPORT     23</span>
<span class="preprocessor"></span>
<span class="keyword">typedef</span> <span class="keyword">struct </span>{
    <a name="a371"></a><a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> *cd_rs232;
    <a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> *cd_tcpip;
    <span class="keywordtype">char</span> cd_connected;
} CHANNEL;

<span class="comment">/*</span>
<span class="comment"> * Transfer data from input stream to output stream.</span>
<span class="comment"> */</span>
<span class="keywordtype">void</span> StreamCopy(<a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> * istream, <a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> * ostream, <span class="keywordtype">char</span> *cop)
{
    <span class="keywordtype">int</span> cnt;
    <span class="keywordtype">char</span> *buff;

    buff = <a name="a372"></a><a class="code" href="group__xgHeap.html#ga2">malloc</a>(BUFFERSIZE);
    <span class="keywordflow">while</span> (*cop) {
        <span class="keywordflow">if</span> ((cnt = <a name="a373"></a><a class="code" href="group__xgCrtStdio.html#ga24">fread</a>(buff, 1, BUFFERSIZE, istream)) &lt;= 0)
            <span class="keywordflow">break</span>;
        <span class="keywordflow">if</span> (*cop &amp;&amp; (cnt = <a name="a374"></a><a class="code" href="group__xgCrtStdio.html#ga30">fwrite</a>(buff, 1, cnt, ostream)) &lt;= 0)
            <span class="keywordflow">break</span>;
        <span class="keywordflow">if</span> (*cop &amp;&amp; <a name="a375"></a><a class="code" href="group__xgCrtStdio.html#ga11">fflush</a>(ostream))
            <span class="keywordflow">break</span>;
    }
    *cop = 0;
    <a name="a376"></a><a class="code" href="group__xgHeap.html#ga3">free</a>(buff);
}

<span class="comment">/*</span>
<span class="comment"> * From RS232 to socket.</span>
<span class="comment"> */</span>
<a name="a377"></a><a class="code" href="thread_8h.html#a6">THREAD</a>(Receiver, arg)
{
    CHANNEL *cdp = arg;

    <span class="keywordflow">for</span> (;;) {
        <span class="keywordflow">if</span> (cdp-&gt;cd_connected) {
            <a name="a378"></a><a class="code" href="group__xgThread.html#ga10">NutThreadSetPriority</a>(64);
            <span class="comment">/*</span>
<span class="comment">             * We are reading from the UART without any timeout. So we</span>
<span class="comment">             * won't return immediately when disconnected.</span>
<span class="comment">             */</span>
            StreamCopy(cdp-&gt;cd_rs232, cdp-&gt;cd_tcpip, &amp;cdp-&gt;cd_connected);
            <a class="code" href="group__xgThread.html#ga10">NutThreadSetPriority</a>(128);
        }
        <a name="a379"></a><a class="code" href="group__xgThread.html#ga9">NutThreadYield</a>();
    }
}

<span class="comment">/*</span>
<span class="comment"> * Main application routine. </span>
<span class="comment"> *</span>
<span class="comment"> * Nut/OS automatically calls this entry after initialization.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
    <a name="_a380"></a><a class="code" href="structtcp__socket.html">TCPSOCKET</a> *sock;
    CHANNEL cd;
    <a name="a381"></a><a class="code" href="group__xgNutOS.html#ga3">u_long</a> baud = 9600;

    <span class="comment">/*</span>
<span class="comment">     * Register our devices.</span>
<span class="comment">     */</span>
    <a name="a382"></a><a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_UART, 0, 0);
    <a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_ETHER, 0x8300, 5);

    <span class="comment">/*</span>
<span class="comment">     * Setup the uart device.</span>
<span class="comment">     */</span>
    cd.cd_rs232 = <a name="a383"></a><a class="code" href="group__xgCrtStdio.html#ga17">fopen</a>(DEV_UART_NAME, <span class="stringliteral">"r+b"</span>);
    <a name="a384"></a><a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(<a name="a385"></a><a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(cd.cd_rs232), <a name="a386"></a><a class="code" href="group__xgUARTIOCTL.html#ga0">UART_SETSPEED</a>, &amp;baud);

    <span class="comment">/*</span>
<span class="comment">     * Setup the ethernet device. Try DHCP first. If this is</span>
<span class="comment">     * the first time boot with empty EEPROM and no DHCP server</span>
<span class="comment">     * was found, use hardcoded values.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (<a name="a387"></a><a class="code" href="pro_2dhcp_8h.html#a17">NutDhcpIfConfig</a>(DEV_ETHER_NAME, 0, 60000)) {
        <span class="comment">/* No valid EEPROM contents, use hard coded MAC. */</span>
        <a name="a388"></a><a class="code" href="group__xgNutOS.html#ga0">u_char</a> my_mac[] = { 0x00, 0x06, 0x98, 0x20, 0x00, 0x00 };

        <span class="keywordflow">if</span> (<a class="code" href="pro_2dhcp_8h.html#a17">NutDhcpIfConfig</a>(<span class="stringliteral">"eth0"</span>, my_mac, 60000)) {
            <span class="comment">/* No DHCP server found, use hard coded IP address. */</span>
            <a class="code" href="group__xgNutOS.html#ga3">u_long</a> ip_addr = <a name="a389"></a><a class="code" href="group__xgIP.html#ga8">inet_addr</a>(<span class="stringliteral">"192.168.192.100"</span>);
            <a class="code" href="group__xgNutOS.html#ga3">u_long</a> ip_mask = <a class="code" href="group__xgIP.html#ga8">inet_addr</a>(<span class="stringliteral">"255.255.255.0"</span>);

            <a name="a390"></a><a class="code" href="group__xgIP.html#ga6">NutNetIfConfig</a>(<span class="stringliteral">"eth0"</span>, my_mac, ip_addr, ip_mask);
            <span class="comment">/* If not in a local network, we must also call </span>
<span class="comment">               NutIpRouteAdd() to configure the routing. */</span>
        }
    }

    <span class="comment">/*</span>
<span class="comment">     * Start a RS232 receiver thread.</span>
<span class="comment">     */</span>
    <a name="a391"></a><a class="code" href="group__xgNutArchAvrOsContextGcc.html#ga2">NutThreadCreate</a>(<span class="stringliteral">"xmit"</span>, Receiver, &amp;cd, 512);

    <span class="comment">/*</span>
<span class="comment">     * Now loop endless for connections.</span>
<span class="comment">     */</span>
    cd.cd_connected = 0;
    <span class="keywordflow">for</span> (;;) {
        <span class="comment">/*</span>
<span class="comment">         * Create a socket and listen for a client.</span>
<span class="comment">         */</span>
        sock = <a name="a392"></a><a class="code" href="group__xgTcpSocket.html#ga7">NutTcpCreateSocket</a>();
        <a name="a393"></a><a class="code" href="group__xgTcpSocket.html#ga11">NutTcpAccept</a>(sock, TCPPORT);

        <span class="comment">/*</span>
<span class="comment">         * Open a stdio stream assigned to the connected socket.</span>
<span class="comment">         */</span>
        cd.cd_tcpip = <a name="a394"></a><a class="code" href="group__xgCrtStdio.html#ga8">_fdopen</a>((<span class="keywordtype">int</span>) sock, <span class="stringliteral">"r+b"</span>);
        cd.cd_connected = 1;

        <span class="comment">/*</span>
<span class="comment">         * Call RS232 transmit routine. On return we will be</span>
<span class="comment">         * disconnected again.</span>
<span class="comment">         */</span>
        StreamCopy(cd.cd_tcpip, cd.cd_rs232, &amp;cd.cd_connected);

        <span class="comment">/*</span>
<span class="comment">         * Close the stream.</span>
<span class="comment">         */</span>
        <a name="a395"></a><a class="code" href="group__xgCrtStdio.html#ga6">fclose</a>(cd.cd_tcpip);

        <span class="comment">/*</span>
<span class="comment">         * Close our socket.</span>
<span class="comment">         */</span>
        <a name="a396"></a><a class="code" href="group__xgTcpSocket.html#ga14">NutTcpCloseSocket</a>(sock);
    }
}
</pre></div> <hr>
<address>
  <small>
    &copy;&nbsp;2000-2006 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
