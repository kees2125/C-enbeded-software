<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>playmp3/playmp3.c</h1>To run this example code, you need to attach the Medianut Board to the Ethernut or use a similar hardware design based on the VS1001K MP3 decoder.<p>
This sample application plays MP3 files from the UROM filesystem. It demonstrates how to use the global segmented buffer and the MP3 decoder driver and can provide a basis for talking equipment, alarm sound output etc.<p>
The UROM filesystem is located in the CPU's flash ROM. No external file storage device is required. Use the crurom utility to create a C source file named urom.c from the MP3 files located in subdirectory sounds. Here's how to call crurom:<p>
crurom -r -ourom.c sounds<p>
The created file will then be compiled and linked to the application code.<p>
UART0 is used for debug output.<p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * Copyright (C) 2003-2006 by egnite Software GmbH. All rights reserved.</span>
<span class="comment"> *</span>
<span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<span class="comment"> * modification, are permitted provided that the following conditions</span>
<span class="comment"> * are met:</span>
<span class="comment"> *</span>
<span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<span class="comment"> *    from this software without specific prior written permission.</span>
<span class="comment"> *</span>
<span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="comment"> * SUCH DAMAGE.</span>
<span class="comment"> *</span>
<span class="comment"> * For additional information see http://www.ethernut.de/</span>
<span class="comment"> *</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;dev/board.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="vs1001k_8h.html">dev/vs1001k.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">dev/debug.h</a>&gt;</span>
<span class="preprocessor">#include &lt;dev/urom.h&gt;</span>

<span class="preprocessor">#include &lt;sys/version.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html">sys/heap.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="event_8h.html">sys/event.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html">sys/timer.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html">sys/thread.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2bankmem_8h.html">sys/bankmem.h</a>&gt;</span>

<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;io.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html">fcntl.h</a>&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>

<span class="keyword">static</span> <span class="keywordtype">int</span> PlayMp3File(<span class="keywordtype">char</span> *path);

<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
    <span class="comment">/* Baudrate for debug output. */</span>
    <a name="a232"></a><a class="code" href="group__xgNutOS.html#ga3">u_long</a> baud = 115200;

    <span class="comment">/*</span>
<span class="comment">     * Register our devices.</span>
<span class="comment">     */</span>
    <a name="a233"></a><a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;<a name="a234"></a><a class="code" href="group__xgurom.html#ga0">devUrom</a>, 0, 0);
    <a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_DEBUG, 0, 0);

    <span class="comment">/*</span>
<span class="comment">     * Assign stdout to the debug device.</span>
<span class="comment">     */</span>
    <a name="a235"></a><a class="code" href="group__xgCrtStdio.html#ga25">freopen</a>(DEV_DEBUG_NAME, <span class="stringliteral">"w"</span>, <a name="a236"></a><a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>);
    <a name="a237"></a><a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(<a name="a238"></a><a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>), <a name="a239"></a><a class="code" href="group__xgUARTIOCTL.html#ga0">UART_SETSPEED</a>, &amp;baud);

    <span class="comment">/*</span>
<span class="comment">     * Print a banner.</span>
<span class="comment">     */</span>
    <a name="a240"></a><a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"\n\nPlay MP3 files on Nut/OS %s\n"</span>, <a name="a241"></a><a class="code" href="group__xgNutVersion.html#ga1">NutVersionString</a>());

<span class="preprocessor">#if defined(__AVR__)</span>
<span class="preprocessor"></span>
    <span class="comment">/*</span>
<span class="comment">     * Initialize the MP3 buffer. The NutSegBuf routines provide a global</span>
<span class="comment">     * system buffer, which works with banked and non-banked systems.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (<a name="a242"></a><a class="code" href="group__xgBankMem.html#ga10">NutSegBufInit</a>(8192) == 0) {
        <a name="a243"></a><a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"NutSegBufInit: Fatal error"</span>);
    }

    <span class="comment">/* </span>
<span class="comment">     * Initialize the MP3 decoder hardware.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (<a name="a244"></a><a class="code" href="group__xgVs1001.html#ga2">VsPlayerInit</a>() || <a name="a245"></a><a class="code" href="group__xgVs1001.html#ga3">VsPlayerReset</a>(0)) {
        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"VsPlayer: Fatal error"</span>);
    }

    <span class="comment">/*</span>
<span class="comment">     * Play the MP3 files in an endless loop. For each file set the volume </span>
<span class="comment">     * of the left and right channel, call the local routine PlayMp3File() </span>
<span class="comment">     * and sleep one second before playing the next sound file.</span>
<span class="comment">     */</span>
    <span class="keywordflow">for</span> (;;) {
        <a name="a246"></a><a class="code" href="group__xgVs1001.html#ga18">VsSetVolume</a>(0, 254);
        PlayMp3File(<span class="stringliteral">"UROM:sound1a.mp3"</span>);
        <a name="a247"></a><a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1000);

        <a class="code" href="group__xgVs1001.html#ga18">VsSetVolume</a>(0, 0);
        PlayMp3File(<span class="stringliteral">"UROM:sound2a.mp3"</span>);
        <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1000);

        <a class="code" href="group__xgVs1001.html#ga18">VsSetVolume</a>(254, 0);
        PlayMp3File(<span class="stringliteral">"UROM:sound3a.mp3"</span>);
        <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1000);

        <a class="code" href="group__xgVs1001.html#ga18">VsSetVolume</a>(0, 0);
        PlayMp3File(<span class="stringliteral">"UROM:sound4a.mp3"</span>);
        <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1000);
    }
<span class="preprocessor">#else </span><span class="comment">/* !__AVR__ */</span>
    <span class="keywordflow">for</span> (;;);
<span class="preprocessor">#endif </span><span class="comment">/* !__AVR__ */</span>
}

<span class="preprocessor">#if defined(__AVR__)</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * Play MP3 file from local file system.</span>
<span class="comment"> *</span>
<span class="comment"> * \param path Pathname of the MP3 file to play.</span>
<span class="comment"> *</span>
<span class="comment"> * \return 0 on success, -1 if opening the file failed.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> PlayMp3File(<span class="keywordtype">char</span> *path)
{
    <span class="keywordtype">int</span> fd;
    size_t rbytes;
    <a name="a248"></a><a class="code" href="group__xgNutOS.html#ga0">u_char</a> *mp3buf;
    <span class="keywordtype">int</span> got;
    <a class="code" href="group__xgNutOS.html#ga0">u_char</a> ief;

    <span class="comment">/*</span>
<span class="comment">     * Open the MP3 file.</span>
<span class="comment">     */</span>
    <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Play %s: "</span>, path);
    <span class="keywordflow">if</span> ((fd = <a name="a249"></a><a class="code" href="group__xgCrtLowio.html#ga3">_open</a>(path, <a name="a250"></a><a class="code" href="group__xgCrtLowio.html#ga9">_O_RDONLY</a> | <a name="a251"></a><a class="code" href="group__xgCrtLowio.html#ga17">_O_BINARY</a>)) == -1) {
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Error %d\n"</span>, errno);
        <span class="keywordflow">return</span> -1;
    }
    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"OK"</span>);

    <span class="comment">/* </span>
<span class="comment">     * Reset decoder buffer.</span>
<span class="comment">     */</span>
    <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"[B.RST]"</span>);
    ief = <a name="a252"></a><a class="code" href="group__xgVs1001.html#ga8">VsPlayerInterrupts</a>(0);
    <a name="a253"></a><a class="code" href="group__xgBankMem.html#ga9">NutSegBufReset</a>();
    <a class="code" href="group__xgVs1001.html#ga8">VsPlayerInterrupts</a>(ief);

    <span class="keywordflow">for</span> (;;) {
        <span class="comment">/*</span>
<span class="comment">         * Query number of byte available in MP3 buffer.</span>
<span class="comment">         */</span>
        ief = <a class="code" href="group__xgVs1001.html#ga8">VsPlayerInterrupts</a>(0);
        mp3buf = <a name="a254"></a><a class="code" href="group__xgBankMem.html#ga11">NutSegBufWriteRequest</a>(&amp;rbytes);
        <a class="code" href="group__xgVs1001.html#ga8">VsPlayerInterrupts</a>(ief);

        <span class="comment">/* </span>
<span class="comment">         * Read data directly into the MP3 buffer. </span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (rbytes) {
            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"[B.RD%d]"</span>, rbytes);
            <span class="keywordflow">if</span> ((got = <a name="a255"></a><a class="code" href="group__xgCrtLowio.html#ga4">_read</a>(fd, mp3buf, rbytes)) &gt; 0) {
                <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"[B.CMT%d]"</span>, got);
                ief = <a class="code" href="group__xgVs1001.html#ga8">VsPlayerInterrupts</a>(0);
                mp3buf = <a name="a256"></a><a class="code" href="group__xgBankMem.html#ga13">NutSegBufWriteCommit</a>(got);
                <a class="code" href="group__xgVs1001.html#ga8">VsPlayerInterrupts</a>(ief);
            } <span class="keywordflow">else</span> {
                <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"[EOF]"</span>);
                <span class="keywordflow">break</span>;
            }
        }

        <span class="comment">/*</span>
<span class="comment">         * If the player is not running, kick it.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a name="a257"></a><a class="code" href="group__xgVs1001.html#ga15">VsGetStatus</a>() != VS_STATUS_RUNNING) {
            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"[P.KICK]"</span>);
            <a name="a258"></a><a class="code" href="group__xgVs1001.html#ga5">VsPlayerKick</a>();
        }

        <span class="comment">/*</span>
<span class="comment">         * Allow background threads to take over.</span>
<span class="comment">         */</span>
        <a name="a259"></a><a class="code" href="group__xgThread.html#ga9">NutThreadYield</a>();
    }

    <a name="a260"></a><a class="code" href="group__xgCrtLowio.html#ga0">_close</a>(fd);

    <span class="comment">/* </span>
<span class="comment">     * Flush decoder and wait until finished. </span>
<span class="comment">     */</span>
    <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"[P.FLUSH]"</span>);
    <a name="a261"></a><a class="code" href="group__xgVs1001.html#ga7">VsPlayerFlush</a>();
    <span class="keywordflow">while</span> (<a class="code" href="group__xgVs1001.html#ga15">VsGetStatus</a>() != VS_STATUS_EMPTY) {
        <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1);
    }

    <span class="comment">/*</span>
<span class="comment">     * Reset the decoder. </span>
<span class="comment">     */</span>
    <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"[P.RST]"</span>);
    <a class="code" href="group__xgVs1001.html#ga3">VsPlayerReset</a>(0);

    <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"\nDone, %u bytes free\n"</span>, <a name="a262"></a><a class="code" href="group__xgHeap.html#ga8">NutHeapAvailable</a>());
    <span class="keywordflow">return</span> 0;
}

<span class="preprocessor">#endif </span><span class="comment">/* !__AVR__ */</span>
</pre></div> <hr>
<address>
  <small>
    &copy;&nbsp;2000-2006 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
