<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>uart/uart.c</h1>This sample demonstrates the usage of the ATmega on-chip UART. Note, that we don't do any error checking, because without this UART we can't tell the user our problem.<p>
We use floating points. Make sure to link with nutlibcrtf.<p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;cfg/crt.h&gt;</span>    <span class="comment">/* Floating point configuration. */</span>

<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;io.h&gt;</span>

<span class="preprocessor">#include &lt;dev/board.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html">sys/timer.h</a>&gt;</span>

<span class="keyword">static</span> <span class="keywordtype">char</span> *banner = <span class="stringliteral">"\nNut/OS UART Sample\n"</span>;
<span class="keyword">static</span> prog_char presskey_P[] = <span class="stringliteral">"Press any key..."</span>;
<span class="keyword">static</span> prog_char pgm_ptr[] = <span class="stringliteral">"\nHello stranger!\n"</span>;

<span class="keyword">static</span> <span class="keywordtype">char</span> inbuf[128];

<span class="comment">/*</span>
<span class="comment"> * UART sample.</span>
<span class="comment"> *</span>
<span class="comment"> * Some functions do not work with ICCAVR.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> got;
    <span class="keywordtype">int</span> i;
    <span class="keywordtype">char</span> *cp;
    <a name="a488"></a><a class="code" href="group__xgNutOS.html#ga3">u_long</a> baud = 115200;
    <a name="a489"></a><a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> *uart;
<span class="preprocessor">#ifdef STDIO_FLOATING_POINT</span>
<span class="preprocessor"></span>    <span class="keywordtype">float</span> dval = 0.0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">/*</span>
<span class="comment">     * Each device must be registered. We do this by referencing the </span>
<span class="comment">     * device structure of the driver. The advantage is, that only </span>
<span class="comment">     * those device drivers are included in our flash code, which we </span>
<span class="comment">     * really need.</span>
<span class="comment">     *</span>
<span class="comment">     * The uart0 device is the first one on the ATmega chip. So it </span>
<span class="comment">     * has no configurable base address or interrupt and we set both </span>
<span class="comment">     * parameters to zero.</span>
<span class="comment">     */</span>
    <a name="a490"></a><a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_UART, 0, 0);

    <span class="comment">/*</span>
<span class="comment">     * Now, as the device is registered, we can open it. The fopen()</span>
<span class="comment">     * function returns a pointer to a FILE structure, which we use </span>
<span class="comment">     * for subsequent reading and writing.</span>
<span class="comment">     */</span>
    uart = <a name="a491"></a><a class="code" href="group__xgCrtStdio.html#ga17">fopen</a>(DEV_UART_NAME, <span class="stringliteral">"r+"</span>);

    <span class="comment">/*</span>
<span class="comment">     * Before doing the first read or write, we set the baudrate.</span>
<span class="comment">     * This low level function doesn't know about FILE structures</span>
<span class="comment">     * and we use _fileno() to get the low level file descriptor</span>
<span class="comment">     * of the stream.</span>
<span class="comment">     *</span>
<span class="comment">     * The short sleep allows the UART to settle after the baudrate</span>
<span class="comment">     * change.</span>
<span class="comment">     */</span>
    <a name="a492"></a><a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(<a name="a493"></a><a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(uart), <a name="a494"></a><a class="code" href="group__xgUARTIOCTL.html#ga0">UART_SETSPEED</a>, &amp;baud);

    <span class="comment">/*</span>
<span class="comment">     * Stream devices can use low level read and write functions. </span>
<span class="comment">     * Writing program space data is supported too.</span>
<span class="comment">     */</span>
    <a name="a495"></a><a class="code" href="group__xgCrtLowio.html#ga7">_write</a>(<a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(uart), banner, <a name="a496"></a><a class="code" href="group__xgCrtString.html#ga14">strlen</a>(banner));
    {
        <a name="a497"></a><a class="code" href="group__xgCrtLowio.html#ga8">_write_P</a>(<a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(uart), presskey_P, <span class="keyword">sizeof</span>(presskey_P));
    }

    <span class="comment">/*</span>
<span class="comment">     * Stream devices do buffered I/O. That means, nothing will be </span>
<span class="comment">     * passed to the hardware device until either the output buffer </span>
<span class="comment">     * is full or we do a flush. With stream I/O we typically use</span>
<span class="comment">     * fflush(), but low level writing a null pointer will also flush </span>
<span class="comment">     * the output buffer.</span>
<span class="comment">     */</span>
    <a class="code" href="group__xgCrtLowio.html#ga7">_write</a>(<a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(uart), 0, 0);

    <span class="comment">/*</span>
<span class="comment">     * The low level function read() will grab all available bytes </span>
<span class="comment">     * from the input buffer. If the buffer is empty, the call will</span>
<span class="comment">     * block until something is available for reading.</span>
<span class="comment">     */</span>
    got = <a name="a498"></a><a class="code" href="group__xgCrtLowio.html#ga4">_read</a>(<a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(uart), inbuf, <span class="keyword">sizeof</span>(inbuf));
    <a class="code" href="group__xgCrtLowio.html#ga7">_write</a>(<a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(uart), inbuf, got);

    <span class="comment">/*</span>
<span class="comment">     * Nut/OS never expects a thread to return. So we enter an </span>
<span class="comment">     * endless loop here.</span>
<span class="comment">     */</span>
    <span class="keywordflow">for</span> (i = 0;; i++) {
        <span class="comment">/*</span>
<span class="comment">         * A bit more advanced input routine is able to read a string </span>
<span class="comment">         * up to and including the first newline character or until a</span>
<span class="comment">         * specified maximum number of characters, whichever comes first.</span>
<span class="comment">         */</span>
        <a name="a499"></a><a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\nEnter your name: "</span>, uart);
        <a name="a500"></a><a class="code" href="group__xgCrtStdio.html#ga11">fflush</a>(uart);
        <a name="a501"></a><a class="code" href="group__xgCrtStdio.html#ga13">fgets</a>(inbuf, <span class="keyword">sizeof</span>(inbuf), uart);

        <span class="comment">/*</span>
<span class="comment">         * Chop off trailing linefeed.</span>
<span class="comment">         */</span>
        cp = <a name="a502"></a><a class="code" href="group__xgCrtString.html#ga8">strchr</a>(inbuf, <span class="charliteral">'\n'</span>);
        <span class="keywordflow">if</span> (cp)
            *cp = 0;

        <span class="comment">/*</span>
<span class="comment">         * Streams support formatted output as well as printing strings </span>
<span class="comment">         * from program space.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (inbuf[0])
            <a name="a503"></a><a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(uart, <span class="stringliteral">"\nHello %s!\n"</span>, inbuf);
        <span class="keywordflow">else</span> {
            <a name="a504"></a><a class="code" href="group__xgCrtStdio.html#ga23">fputs_P</a>(pgm_ptr, uart);
        }

        <span class="comment">/*</span>
<span class="comment">         * Just to demonstrate formatted floating point output.</span>
<span class="comment">         * In order to use this, we need to link the application</span>
<span class="comment">         * with nutcrtf instead of nutcrt for pure integer.</span>
<span class="comment">         */</span>
<span class="preprocessor">#ifdef STDIO_FLOATING_POINT</span>
<span class="preprocessor"></span>        dval += 1.0125;
        <a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(uart, <span class="stringliteral">"FP %f\n"</span>, dval);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
}
</pre></div> <hr>
<address>
  <small>
    &copy;&nbsp;2000-2006 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
