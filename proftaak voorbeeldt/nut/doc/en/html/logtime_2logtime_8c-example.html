<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>logtime/logtime.c</h1>Shows how to use syslog and SNTP.<p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;io.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="inet_8h.html">arpa/inet.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="route_8h.html">net/route.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="pro_2dhcp_8h.html">pro/dhcp.h</a>&gt;</span>
<span class="preprocessor">#include &lt;pro/sntp.h&gt;</span>

<span class="preprocessor">#include &lt;sys/version.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="confnet_8h.html">sys/confnet.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html">sys/timer.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html">sys/heap.h</a>&gt;</span>
<span class="preprocessor">#include &lt;sys/syslog.h&gt;</span>

<span class="preprocessor">#include &lt;dev/board.h&gt;</span>

<span class="keyword">static</span> <span class="keywordtype">char</span> *version = <span class="stringliteral">"1.0.1"</span>;

<span class="comment">/*</span>
<span class="comment"> * User configuration.</span>
<span class="comment"> */</span>

<span class="preprocessor">#define MYMAC   0x00, 0x06, 0x98, 0x00, 0x00, 0x00</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MYIP    "192.168.192.100"</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MYMASK  "255.255.255.0"</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MYGATE  "192.168.192.1"</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MYLOGD  "192.168.192.222"</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MYTIMED "130.149.17.21"</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MYUART  "uart0"</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MYBAUD  115200</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MYDEV   DEV_UART</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MYTZ    -1</span>
<span class="preprocessor"></span>

<span class="preprocessor">#ifdef __IMAGECRAFT__</span>
<span class="preprocessor"></span><span class="preprocessor">#define COMPILERNAME "ICCAVR"</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#define COMPILERNAME "GCC"</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/* Result codes. */</span>
<span class="preprocessor">#define UART_OK     0x0001</span>
<span class="preprocessor"></span><span class="preprocessor">#define STDOUT_OK   0x0002</span>
<span class="preprocessor"></span><span class="preprocessor">#define STDERR_OK   0x0004</span>
<span class="preprocessor"></span><span class="preprocessor">#define BAUDRATE_OK 0x0008</span>
<span class="preprocessor"></span><span class="preprocessor">#define LANDEV_OK   0x0010</span>
<span class="preprocessor"></span><span class="preprocessor">#define NETIF_OK    0x0020</span>
<span class="preprocessor"></span><span class="preprocessor">#define NETROUTE_OK 0x0040</span>
<span class="preprocessor"></span><span class="preprocessor">#define TIMED_OK    0x0080</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * Application entry.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
    <a name="a204"></a><a class="code" href="group__xgNutOS.html#ga3">u_long</a> baud = MYBAUD;
    <a name="a205"></a><a class="code" href="group__xgNutOS.html#ga0">u_char</a> mac[6] = { MYMAC };
    <a class="code" href="group__xgNutOS.html#ga3">u_long</a> timeserver = <a name="a206"></a><a class="code" href="group__xgIP.html#ga8">inet_addr</a>(MYTIMED);
    <span class="keywordtype">int</span> rc = 0;
    <a name="a207"></a><a class="code" href="group__xgCrtTime.html#ga1">time_t</a> now;

    <span class="comment">/*</span>
<span class="comment">     * Register UART devices, assign stdout and stderr to this device</span>
<span class="comment">     * and set the baudrate.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span>(<a name="a208"></a><a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;MYDEV, 0, 0) == 0) {
        rc |= UART_OK;
        <span class="keywordflow">if</span>(<a name="a209"></a><a class="code" href="group__xgCrtStdio.html#ga25">freopen</a>(MYUART, <span class="stringliteral">"w"</span>, <a name="a210"></a><a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>)) {
            rc |= STDOUT_OK;
            <span class="keywordflow">if</span>(<a name="a211"></a><a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(<a name="a212"></a><a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>), <a name="a213"></a><a class="code" href="group__xgUARTIOCTL.html#ga0">UART_SETSPEED</a>, &amp;baud) == 0) {
                rc |= BAUDRATE_OK;
            }
        }
        <span class="keywordflow">if</span>(<a class="code" href="group__xgCrtStdio.html#ga25">freopen</a>(MYUART, <span class="stringliteral">"w"</span>, <a name="a214"></a><a class="code" href="group__xgCrtStdio.html#ga67">stderr</a>)) {
            rc |= STDERR_OK;
        }
    }

    <span class="comment">/*</span>
<span class="comment">     * Print banner.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span>(rc &amp; STDOUT_OK) {
        <a name="a215"></a><a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"\n\nTimeLog %s\nNut/OS %s\n"</span>, version, <a name="a216"></a><a class="code" href="group__xgNutVersion.html#ga1">NutVersionString</a>());
        <a name="a217"></a><a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Compiled by "</span> COMPILERNAME);
        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Configure network"</span>);
    }

    <span class="comment">/*</span>
<span class="comment">     * Register LAN device and configure network interface.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span>(<a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_ETHER, 0x8300, 5) == 0) {
        rc |= LANDEV_OK;
        <span class="keywordflow">if</span> (<a name="a218"></a><a class="code" href="pro_2dhcp_8h.html#a17">NutDhcpIfConfig</a>(<span class="stringliteral">"eth0"</span>, 0, 60000) == 0) {
            rc |= NETIF_OK;
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pro_2dhcp_8h.html#a17">NutDhcpIfConfig</a>(<span class="stringliteral">"eth0"</span>, mac, 60000) == 0) {
            rc |= NETIF_OK;
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a name="a219"></a><a class="code" href="group__xgIP.html#ga6">NutNetIfConfig</a>(<span class="stringliteral">"eth0"</span>, mac, <a class="code" href="group__xgIP.html#ga8">inet_addr</a>(MYIP), <a class="code" href="group__xgIP.html#ga8">inet_addr</a>(MYMASK)) == 0) {
            rc |= NETIF_OK;
<span class="preprocessor">#ifdef MYGATE</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span>(<a name="a220"></a><a class="code" href="group__xgIP.html#ga16">NutIpRouteAdd</a>(0, 0, <a class="code" href="group__xgIP.html#ga8">inet_addr</a>(MYGATE), &amp;DEV_ETHER) == 0) {
                rc |= NETROUTE_OK;
            }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        }
    }

    <span class="keywordflow">if</span>(rc &amp; NETIF_OK) {
        <span class="comment">/*</span>
<span class="comment">         * Set timezone, query SNTP server and set system time.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span>(rc &amp; STDOUT_OK) {
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Query time from "</span> MYTIMED);
        }
        <a name="a221"></a><a class="code" href="group__xgCrtTime.html#ga3">_timezone</a> = MYTZ * 60L * 60L;
        <span class="keywordflow">if</span>(NutSNTPGetTime(&amp;timeserver, &amp;now) == 0) {
            rc |= TIMED_OK;
            <a name="a222"></a><a class="code" href="group__xgCrtTime.html#ga10">stime</a>(&amp;now);
        }
    }

    <span class="comment">/*</span>
<span class="comment">     * Open syslog output and route messages to stderr and to</span>
<span class="comment">     * a remote server.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span>(rc &amp; STDOUT_OK) {
        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Initialize syslog"</span>);
    }
    <a name="a223"></a><a class="code" href="group__xgSyslog.html#ga15">openlog</a>(<span class="stringliteral">"logtime"</span>, (rc &amp; STDERR_OK) ? LOG_PERROR : 0, LOG_USER);
    <span class="keywordflow">if</span>(rc &amp; NETIF_OK) {
        <a name="a224"></a><a class="code" href="group__xgSyslog.html#ga14">setlogserver</a>(<a class="code" href="group__xgIP.html#ga8">inet_addr</a>(MYLOGD), 0);
    }
    <a name="a225"></a><a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_INFO, <span class="stringliteral">"TimeLog %s started on Nut/OS %s"</span>, version, <a class="code" href="group__xgNutVersion.html#ga1">NutVersionString</a>());

    <span class="comment">/*</span>
<span class="comment">     * Print the result of our initialization.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span>((rc &amp; UART_OK) == 0) {
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_ERR, <span class="stringliteral">"Registering UART device failed"</span>);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((rc &amp; STDOUT_OK) == 0) {
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_ERR, <span class="stringliteral">"Assigning stdout failed"</span>);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((rc &amp; STDERR_OK) == 0) {
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_ERR, <span class="stringliteral">"Assigning stderr failed"</span>);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((rc &amp; BAUDRATE_OK) == 0) {
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_ERR, <span class="stringliteral">"Setting baudrate failed"</span>);
    }
    <span class="keywordflow">if</span>((rc &amp; LANDEV_OK) == 0) {
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_ERR, <span class="stringliteral">"Registering Ethernet device failed"</span>);
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((rc &amp; NETIF_OK) == 0) {
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_ERR, <span class="stringliteral">"Configuring network interface failed"</span>);
    }
    <span class="keywordflow">else</span> {
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_INFO, <span class="stringliteral">"IP %s"</span>, <a name="a226"></a><a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(<a name="a227"></a><a class="code" href="group__xgConfNet.html#ga1">confnet</a>.<a name="a228"></a><a class="code" href="struct__CONFNET.html#o3">cdn_ip_addr</a>));
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_INFO, <span class="stringliteral">"Gate %s"</span>, <a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(<a class="code" href="group__xgConfNet.html#ga1">confnet</a>.<a name="a229"></a><a class="code" href="struct__CONFNET.html#o5">cdn_gateway</a>));
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_INFO, <span class="stringliteral">"Timed "</span> MYTIMED);
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_INFO, <span class="stringliteral">"Syslogd "</span> MYLOGD);
    }

    <span class="comment">/*</span>
<span class="comment">     * Endless loop.</span>
<span class="comment">     */</span>
    <span class="keywordflow">for</span>(;;) {
        <a class="code" href="group__xgSyslog.html#ga10">syslog</a>(LOG_DEBUG, <span class="stringliteral">"%d bytes free"</span>, <a name="a230"></a><a class="code" href="group__xgHeap.html#ga8">NutHeapAvailable</a>());
        <a name="a231"></a><a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(60000);
    }
}
</pre></div> <hr>
<address>
  <small>
    &copy;&nbsp;2000-2006 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
