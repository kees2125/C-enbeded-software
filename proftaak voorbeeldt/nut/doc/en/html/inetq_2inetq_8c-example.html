<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>inetq/inetq.c</h1>Requests an URL from the Internet and transfers the HTML source code to the serial device.<p>
Your local Ethernet network must provide Internet access. Connect the RS232 port of the Ethernut with a free COM port of your PC and run a terminal emulator at 115200 Baud.<p>
If your local network does not support DHCP, it may be required to modify the MY_IP, MY_MASK and MY_GATE below.<p>
This sample demonstrates DNS query and default route usage.<p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#define DNSSERVERIP     "192.168.192.2"</span>
<span class="preprocessor"></span><span class="preprocessor">#define INETSERVER  "www.kornet.net"</span>
<span class="preprocessor"></span><span class="preprocessor">#define INETSERVERPORT  80</span>
<span class="preprocessor"></span><span class="preprocessor">#define INETURL         "/"</span>
<span class="preprocessor"></span><span class="preprocessor">#define MY_MAC          {0x00,0x06,0x98,0x20,0x00,0x00}</span>
<span class="preprocessor"></span><span class="preprocessor">#define MY_IP           "192.168.192.100"</span>
<span class="preprocessor"></span><span class="preprocessor">#define MY_MASK         "255.255.255.0"</span>
<span class="preprocessor"></span><span class="preprocessor">#define MY_GATE         "192.168.192.3"</span>
<span class="preprocessor"></span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;io.h&gt;</span>

<span class="preprocessor">#include &lt;dev/board.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html">sys/heap.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html">sys/thread.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html">sys/timer.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html">sys/socket.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="confnet_8h.html">sys/confnet.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="inet_8h.html">arpa/inet.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="route_8h.html">net/route.h</a>&gt;</span>
<span class="preprocessor">#include &lt;netdb.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="pro_2dhcp_8h.html">pro/dhcp.h</a>&gt;</span>

<span class="keyword">static</span> <span class="keywordtype">char</span> buff[1024];
<span class="keyword">static</span> <a name="a169"></a><a class="code" href="group__xgNutOS.html#ga0">u_char</a> my_mac[] = MY_MAC;

<span class="comment">/*</span>
<span class="comment"> * Main application routine. </span>
<span class="comment"> *</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
    <a name="a170"></a><a class="code" href="group__xgNutOS.html#ga3">u_long</a> baud = 115200;
    <a name="_a171"></a><a class="code" href="structtcp__socket.html">TCPSOCKET</a> *sock;
    <a name="a172"></a><a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> *stream;
    <a class="code" href="group__xgNutOS.html#ga3">u_long</a> rip;
    <a class="code" href="group__xgNutOS.html#ga3">u_long</a> ip_addr;
    <span class="keywordtype">int</span> bite;
    size_t rc;
    size_t len;
    <a class="code" href="group__xgNutOS.html#ga3">u_long</a> start_time;
    <a class="code" href="group__xgNutOS.html#ga3">u_long</a> total_bytes;

    <span class="comment">/*</span>
<span class="comment">     * Initialize the uart device.</span>
<span class="comment">     */</span>
    <a name="a173"></a><a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_DEBUG, 0, 0);
    <a name="a174"></a><a class="code" href="group__xgCrtStdio.html#ga25">freopen</a>(DEV_DEBUG_NAME, <span class="stringliteral">"w"</span>, <a name="a175"></a><a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>);
    <a name="a176"></a><a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(<a name="a177"></a><a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>), <a name="a178"></a><a class="code" href="group__xgUARTIOCTL.html#ga0">UART_SETSPEED</a>, &amp;baud);
    <a name="a179"></a><a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"\nInetQuery 1.0"</span>);

    <span class="comment">/*</span>
<span class="comment">     * Register Realtek controller at address 8300 hex and interrupt 5.</span>
<span class="comment">     */</span>
    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Configuring Ethernet interface"</span>);
    <a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DEV_ETHER, 0, 0);

    <span class="comment">/*</span>
<span class="comment">     * Try DHCP. First use MAC from EEPROM.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (<a name="a180"></a><a class="code" href="pro_2dhcp_8h.html#a17">NutDhcpIfConfig</a>(<span class="stringliteral">"eth0"</span>, 0, 60000) &amp;&amp; <a class="code" href="pro_2dhcp_8h.html#a17">NutDhcpIfConfig</a>(<span class="stringliteral">"eth0"</span>, my_mac, 60000)) {
        <span class="comment">/*</span>
<span class="comment">         * No DHCP server available. Use hard coded values.</span>
<span class="comment">         */</span>
        ip_addr = <a name="a181"></a><a class="code" href="group__xgIP.html#ga8">inet_addr</a>(MY_IP);
        <a name="a182"></a><a class="code" href="group__xgIP.html#ga6">NutNetIfConfig</a>(<span class="stringliteral">"eth0"</span>, my_mac, ip_addr, <a class="code" href="group__xgIP.html#ga8">inet_addr</a>(MY_MASK));
        <a name="a183"></a><a class="code" href="group__xgIP.html#ga16">NutIpRouteAdd</a>(0, 0, <a class="code" href="group__xgIP.html#ga8">inet_addr</a>(MY_GATE), &amp;DEV_ETHER);
        <a name="a184"></a><a class="code" href="group__xgDNS.html#ga22">NutDnsConfig</a>(0, 0, <a class="code" href="group__xgIP.html#ga8">inet_addr</a>(DNSSERVERIP));
    } <span class="keywordflow">else</span>
        ip_addr = <a name="a185"></a><a class="code" href="group__xgConfNet.html#ga1">confnet</a>.<a name="a186"></a><a class="code" href="struct__CONFNET.html#o3">cdn_ip_addr</a>;
    <a name="a187"></a><a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"%s ready\n"</span>, <a name="a188"></a><a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(ip_addr));


    <span class="comment">/*</span>
<span class="comment">     * Resolve hostname using DNS.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> ((rip = NutDnsGetHostByName(INETSERVER)) != 0) {

        <span class="comment">/*</span>
<span class="comment">         * Let's try a stdio stream first.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> ((sock = <a name="a189"></a><a class="code" href="group__xgTcpSocket.html#ga7">NutTcpCreateSocket</a>()) != 0) {

            <span class="comment">/*</span>
<span class="comment">             * Connect a HTTP server in the Internet.</span>
<span class="comment">             */</span>
            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Connecting %s:%u\r\n"</span>, <a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(rip), INETSERVERPORT);
            <span class="keywordflow">if</span> (<a name="a190"></a><a class="code" href="group__xgTcpSocket.html#ga10">NutTcpConnect</a>(sock, rip, INETSERVERPORT) == 0) {

                <span class="comment">/*</span>
<span class="comment">                 * Assign a stream to our connected socket.</span>
<span class="comment">                 */</span>
                <span class="keywordflow">if</span> ((stream = <a name="a191"></a><a class="code" href="group__xgCrtStdio.html#ga8">_fdopen</a>((<span class="keywordtype">int</span>) sock, <span class="stringliteral">"r+b"</span>)) != 0) {
                    <span class="comment">/*</span>
<span class="comment">                     * Send HTTP request to the server.</span>
<span class="comment">                     */</span>
                    <a name="a192"></a><a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(stream, <span class="stringliteral">"GET %s HTTP/1.0\r\n"</span>, INETURL);
                    <a name="a193"></a><a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"User-Agent: Ethernut [en] (NutOS)\r\n"</span>, stream);
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\r\n"</span>, stream);
                    <a name="a194"></a><a class="code" href="group__xgCrtStdio.html#ga11">fflush</a>(stream);

                    <span class="comment">/*</span>
<span class="comment">                     * Init measure values.</span>
<span class="comment">                     */</span>
                    start_time = <a name="a195"></a><a class="code" href="group__xgTimer.html#ga12">NutGetTickCount</a>();
                    total_bytes = 0;

                    <span class="comment">/*</span>
<span class="comment">                     * Read server response and send it to the UART.</span>
<span class="comment">                     */</span>
                    <span class="keywordflow">while</span> (<a name="a196"></a><a class="code" href="group__xgCrtStdio.html#ga13">fgets</a>(buff, <span class="keyword">sizeof</span>(buff), stream)) {
                        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(buff);
                        total_bytes += <a name="a197"></a><a class="code" href="group__xgCrtString.html#ga14">strlen</a>(buff);
                    }
                    <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Transfered %lu bytes in %lu seconds\n"</span>, total_bytes, (<a class="code" href="group__xgTimer.html#ga12">NutGetTickCount</a>() - start_time) / 16UL);
                    <a name="a198"></a><a class="code" href="group__xgCrtStdio.html#ga6">fclose</a>(stream);
                } <span class="keywordflow">else</span>
                    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Creating stream device failed"</span>);

            } <span class="keywordflow">else</span> {
                <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Bad news, %s refuses the connection.\n"</span>, INETSERVER);
            }
            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Disconnecting %s:%u\n"</span>, <a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(rip), INETSERVERPORT);
            <a name="a199"></a><a class="code" href="group__xgTcpSocket.html#ga14">NutTcpCloseSocket</a>(sock);
        }

        <a name="a200"></a><a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(5000);

        <span class="comment">/*</span>
<span class="comment">         * Now let's use native calls.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> ((sock = <a class="code" href="group__xgTcpSocket.html#ga7">NutTcpCreateSocket</a>()) != 0) {

            <span class="comment">/*</span>
<span class="comment">             * Connect a HTTP server in the Internet.</span>
<span class="comment">             */</span>
            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Connecting %s:%u\r\n"</span>, <a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(rip), INETSERVERPORT);
            <span class="keywordflow">if</span> (<a class="code" href="group__xgTcpSocket.html#ga10">NutTcpConnect</a>(sock, rip, INETSERVERPORT) == 0) {

                <span class="comment">/*</span>
<span class="comment">                 * Send HTTP request to the server. NutTcpSend() doesn't</span>
<span class="comment">                 * guarantee to send out all bytes, thus the loop.</span>
<span class="comment">                 */</span>
                <a name="a201"></a><a class="code" href="group__xgCrtString.html#ga10">strcpy</a>(buff, <span class="stringliteral">"GET "</span> INETURL <span class="stringliteral">" HTTP/1.0\r\nUser-Agent: Ethernut [en] (NutOS)\r\n\r\n"</span>);
                len = (int) <a class="code" href="group__xgCrtString.html#ga14">strlen</a>(buff);
                <span class="keywordflow">for</span> (rc = 0; rc &lt; len; rc += bite)
                    <span class="keywordflow">if</span> ((bite = <a name="a202"></a><a class="code" href="group__xgTcpSocket.html#ga12">NutTcpSend</a>(sock, buff + rc, len - rc)) &lt;= 0)
                        <span class="keywordflow">break</span>;

                <span class="comment">/*</span>
<span class="comment">                 * Init measure values.</span>
<span class="comment">                 */</span>
                start_time = <a class="code" href="group__xgTimer.html#ga12">NutGetTickCount</a>();
                total_bytes = 0;

                <span class="comment">/*</span>
<span class="comment">                 * Read server response and send it to the UART.</span>
<span class="comment">                 */</span>
                <span class="keywordflow">while</span> ((bite = <a name="a203"></a><a class="code" href="group__xgTcpSocket.html#ga13">NutTcpReceive</a>(sock, buff, <span class="keyword">sizeof</span>(buff) - 1)) &gt; 0) {
                    total_bytes += bite;
                    buff[bite] = 0;
                    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(buff);
                }
                <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Transfered %lu bytes in %lu seconds\n"</span>, total_bytes, (<a class="code" href="group__xgTimer.html#ga12">NutGetTickCount</a>() - start_time) / 16UL);
            } <span class="keywordflow">else</span> {
                <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Bad news, %s refuses the connection.\n"</span>, INETSERVER);
            }
            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Disconnecting %s:%u\n"</span>, <a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(rip), INETSERVERPORT);
            <a class="code" href="group__xgTcpSocket.html#ga14">NutTcpCloseSocket</a>(sock);
        }
    } <span class="keywordflow">else</span>
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Great news, %s has been removed!\n"</span>, INETSERVER);

    <span class="keywordflow">for</span> (;;)
        <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1000);
}
</pre></div> <hr>
<address>
  <small>
    &copy;&nbsp;2000-2006 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
