<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>pppc/pppc.c</h1>PPP client. Similar to the TCP server sample, but uses PPP over RS232.<p>
The default settings in this sample may be used to connect to a RAS server of a Windows PC. When adding a similar modem script, it will also work with a Linux PC nearly out of the box. At least you need to change the PPPUSER and PPPPASS.<p>
<dl compact><dt><b><a class="el" href="bug.html#_bug000001">Bug:</a></b></dt><dd>This sample works with ICCAVR (6.28 tested) only with debugging enabled.</dd></dl>
<dl compact><dt><b><a class="el" href="bug.html#_bug000001">Bug:</a></b></dt><dd>Not working with ATmega103. Debug output needs to be removed. </dd></dl>
<p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * Copyright (C) 2003-2006 by egnite Software GmbH. All rights reserved.</span>
<span class="comment"> *</span>
<span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<span class="comment"> * modification, are permitted provided that the following conditions</span>
<span class="comment"> * are met:</span>
<span class="comment"> *</span>
<span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<span class="comment"> *    from this software without specific prior written permission.</span>
<span class="comment"> *</span>
<span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="comment"> * SUCH DAMAGE.</span>
<span class="comment"> *</span>
<span class="comment"> * For additional information see http://www.ethernut.de/</span>
<span class="comment"> *</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;cfg/arch.h&gt;</span>

<span class="comment">/*</span>
<span class="comment"> * PPP user and password.</span>
<span class="comment"> */</span>
<span class="preprocessor">#define PPPUSER     "me"</span>
<span class="preprocessor"></span><span class="preprocessor">#define PPPPASS     "secret"</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * The Nut/OS modem chat utility works similar to the the UNIX</span>
<span class="comment"> * chat script. This one is used to connect to a Windows PC</span>
<span class="comment"> * using a direct cable.</span>
<span class="comment"> */</span>
<span class="preprocessor">#define PPPCHAT     "TIMEOUT 2 '' CLIENT\\c CLIENTSERVER"</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * A very simple modem script.</span>
<span class="comment"> */</span>
<span class="comment">//#define PPPCHAT     "'' AT OK ATD555 CONNECT"</span>


<span class="comment">/*</span>
<span class="comment"> * PPP device settings.</span>
<span class="comment"> */</span>
<span class="preprocessor">#if defined(__AVR__)</span>
<span class="preprocessor"></span><span class="preprocessor">#define PPPDEV      devAhdlc0   </span><span class="comment">/* Use HDLC driver. */</span>
<span class="comment">//#define PPPDEV      devUart0    /* Use standard UART driver. */</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#warning "Works on ATmega128 only."</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#define PPPCOM      "uart0"     </span><span class="comment">/* Physical device name. */</span>
<span class="preprocessor">#define PPPSPEED    115200      </span><span class="comment">/* Baudrate. */</span>
<span class="preprocessor">#define PPPRXTO     1000        </span><span class="comment">/* Character receive timeout. */</span>


<span class="comment">/*</span>
<span class="comment"> * Server input buffer size.</span>
<span class="comment"> */</span>
<span class="preprocessor">#define RXBUFFSIZE  256</span>
<span class="preprocessor"></span>
<span class="preprocessor">#include &lt;cfg/os.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">dev/debug.h</a>&gt;</span>
<span class="comment">//#include &lt;dev/hd44780.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="ahdlcavr_8h.html">dev/ahdlcavr.h</a>&gt;</span>
<span class="comment">//#include &lt;dev/uartavr.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="dev_2ppp_8h.html">dev/ppp.h</a>&gt;</span>
<span class="preprocessor">#include &lt;dev/chat.h&gt;</span>

<span class="preprocessor">#include &lt;sys/version.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html">sys/heap.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html">sys/thread.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html">sys/socket.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html">sys/timer.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="inet_8h.html">arpa/inet.h</a>&gt;</span>
<span class="preprocessor">#include &lt;netdb.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="if__var_8h.html">net/if_var.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="route_8h.html">net/route.h</a>&gt;</span>

<span class="preprocessor">#ifdef NUTDEBUG</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;net/netdebug.h&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;io.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html">fcntl.h</a>&gt;</span>

<span class="preprocessor">#if defined(__IMAGECRAFT__)</span>
<span class="preprocessor"></span><span class="preprocessor">#define CC_STRING   "ICCAVR"</span>
<span class="preprocessor"></span><span class="preprocessor">#elif defined(__GNUC__)</span>
<span class="preprocessor"></span><span class="preprocessor">#define CC_STRING   "AVRGCC"</span>
<span class="preprocessor"></span><span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#define CC_STRING   "Compiler unknown"</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * Debug output device settings.</span>
<span class="comment"> */</span>
<span class="preprocessor">#ifdef __AVR_ENHANCED__</span>
<span class="preprocessor"></span><span class="preprocessor">#define DBGDEV      devDebug1   </span><span class="comment">/* Use debug driver. */</span>
<span class="comment">//#define DBGDEV      devUart1    /* Use standard UART driver. */</span>
<span class="preprocessor">#define DBGCOM      "uart1"     </span><span class="comment">/* Device name. */</span>
<span class="preprocessor">#define DBGSPEED    115200      </span><span class="comment">/* Baudrate. */</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
prog_char vbanner_P[] = <span class="stringliteral">"\n\nPPP Client Sample - Nut/OS %s - "</span> CC_STRING <span class="stringliteral">"\n"</span>;
prog_char banner_P[] = <span class="stringliteral">"200 Welcome to tcps. Type help to get help.\r\n"</span>;
prog_char help_P[] = <span class="stringliteral">"400 List of commands follows\r\n"</span>
    <span class="stringliteral">"m[emory]\tQueries number of RAM bytes free.\r\n"</span>
    <span class="stringliteral">"t[hreads]\tLists all created threads.\r\n"</span>
    <span class="stringliteral">"ti[mers]\tLists all running timers.\r\n"</span> <span class="stringliteral">"q[uit]\t\tTerminates connection.\r\n"</span> <span class="stringliteral">".\r\n"</span>;
prog_char thread_intro_P[] = <span class="stringliteral">"220 List of threads with name,state,prio,stack,mem,timeout follows\r\n"</span>;
prog_char timer_intro_P[] = <span class="stringliteral">"221 List of timers with ticks left and interval follows\r\n"</span>;
prog_char mem_fmt_P[] = <span class="stringliteral">"210 %u bytes RAM free\r\n"</span>;


<span class="comment">/*</span>
<span class="comment"> * Process client requests.</span>
<span class="comment"> */</span>
<span class="keywordtype">void</span> ProcessRequests(<a name="a307"></a><a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> * stream)
{
    <span class="keywordtype">int</span> got;
    <span class="keywordtype">char</span> *cp;
    <span class="keywordtype">char</span> *buff;

    <span class="comment">/*</span>
<span class="comment">     * We allocate the input buffer from heap memory.</span>
<span class="comment">     */</span>
    buff = <a name="a308"></a><a class="code" href="group__xgHeap.html#ga2">malloc</a>(RXBUFFSIZE);

    <span class="comment">/*</span>
<span class="comment">     * Send a welcome banner.</span>
<span class="comment">     */</span>
    <a name="a309"></a><a class="code" href="group__xgCrtStdio.html#ga23">fputs_P</a>(banner_P, stream);
    <span class="keywordflow">for</span> (;;) {

        <span class="comment">/*</span>
<span class="comment">         * Flush output and read a line.</span>
<span class="comment">         */</span>
        <a name="a310"></a><a class="code" href="group__xgCrtStdio.html#ga11">fflush</a>(stream);
        <span class="keywordflow">if</span> (<a name="a311"></a><a class="code" href="group__xgCrtStdio.html#ga13">fgets</a>(buff, RXBUFFSIZE, stream) == 0)
            <span class="keywordflow">break</span>;

        <span class="comment">/*</span>
<span class="comment">         * Chop off EOL.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> ((cp = <a name="a312"></a><a class="code" href="group__xgCrtString.html#ga8">strchr</a>(buff, <span class="charliteral">'\r'</span>)) != 0)
            *cp = 0;
        <span class="keywordflow">if</span> ((cp = <a class="code" href="group__xgCrtString.html#ga8">strchr</a>(buff, <span class="charliteral">'\n'</span>)) != 0)
            *cp = 0;

        <span class="comment">/*</span>
<span class="comment">         * Ignore blank lines.</span>
<span class="comment">         */</span>
        got = <a name="a313"></a><a class="code" href="group__xgCrtString.html#ga14">strlen</a>(buff);
        <span class="keywordflow">if</span> (got == 0)
            <span class="keywordflow">continue</span>;

        <span class="comment">/*</span>
<span class="comment">         * Memory info.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a name="a314"></a><a class="code" href="group__xgCrtString.html#ga16">strncmp</a>(buff, <span class="stringliteral">"memory"</span>, got) == 0) {
            <a name="a315"></a><a class="code" href="group__xgCrtStdio.html#ga19">fprintf_P</a>(stream, mem_fmt_P, <a name="a316"></a><a class="code" href="group__xgHeap.html#ga8">NutHeapAvailable</a>());
            <span class="keywordflow">continue</span>;
        }

        <span class="comment">/*</span>
<span class="comment">         * List threads.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a class="code" href="group__xgCrtString.html#ga16">strncmp</a>(buff, <span class="stringliteral">"threads"</span>, got) == 0) {
            <a name="_a317"></a><a class="code" href="struct__NUTTHREADINFO.html">NUTTHREADINFO</a> *tdp;
            <a name="_a318"></a><a class="code" href="struct__NUTTIMERINFO.html">NUTTIMERINFO</a> *tnp;

            <a class="code" href="group__xgCrtStdio.html#ga23">fputs_P</a>(thread_intro_P, stream);
            <span class="keywordflow">for</span> (tdp = <a name="a319"></a><a class="code" href="group__xgThread.html#ga3">nutThreadList</a>; tdp; tdp = tdp-&gt;<a name="a320"></a><a class="code" href="struct__NUTTHREADINFO.html#o0">td_next</a>) {
                <a name="a321"></a><a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(tdp-&gt;<a name="a322"></a><a class="code" href="struct__NUTTHREADINFO.html#o3">td_name</a>, stream);
                <span class="keywordflow">switch</span> (tdp-&gt;<a name="a323"></a><a class="code" href="struct__NUTTHREADINFO.html#o4">td_state</a>) {
                <span class="keywordflow">case</span> <a name="a324"></a><a class="code" href="thread_8h.html#a1">TDS_TERM</a>:
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tTerm\t"</span>, stream);
                    <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <a name="a325"></a><a class="code" href="thread_8h.html#a2">TDS_RUNNING</a>:
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tRun\t"</span>, stream);
                    <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <a name="a326"></a><a class="code" href="thread_8h.html#a3">TDS_READY</a>:
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tReady\t"</span>, stream);
                    <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <a name="a327"></a><a class="code" href="thread_8h.html#a4">TDS_SLEEP</a>:
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tSleep\t"</span>, stream);
                    <span class="keywordflow">break</span>;
                }
                <a name="a328"></a><a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(stream, <span class="stringliteral">"%u\t%u"</span>, tdp-&gt;<a name="a329"></a><a class="code" href="struct__NUTTHREADINFO.html#o6">td_priority</a>, (<a name="a330"></a><a class="code" href="group__xgNutOS.html#ga1">u_short</a>) tdp-&gt;<a name="a331"></a><a class="code" href="struct__NUTTHREADINFO.html#o5">td_sp</a> - (<a class="code" href="group__xgNutOS.html#ga1">u_short</a>) tdp-&gt;<a name="a332"></a><a class="code" href="struct__NUTTHREADINFO.html#o7">td_memory</a>);
                <span class="keywordflow">if</span> (*((<a name="a333"></a><a class="code" href="group__xgNutOS.html#ga3">u_long</a> *) tdp-&gt;<a class="code" href="struct__NUTTHREADINFO.html#o7">td_memory</a>) != DEADBEEF)
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tCorrupted\t"</span>, stream);
                <span class="keywordflow">else</span>
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"\tOK\t"</span>, stream);

                <span class="keywordflow">if</span> ((tnp = (<a class="code" href="struct__NUTTIMERINFO.html">NUTTIMERINFO</a> *) tdp-&gt;<a name="a334"></a><a class="code" href="struct__NUTTHREADINFO.html#o8">td_timer</a>) != 0)
                    <a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(stream, <span class="stringliteral">"%lu\r\n"</span>, tnp-&gt;<a name="a335"></a><a class="code" href="struct__NUTTIMERINFO.html#o3">tn_ticks_left</a>);
                <span class="keywordflow">else</span>
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"None\r\n"</span>, stream);
            }
            <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">".\r\n"</span>, stream);
            <span class="keywordflow">continue</span>;
        }

        <span class="comment">/*</span>
<span class="comment">         * List timers.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a class="code" href="group__xgCrtString.html#ga16">strncmp</a>(<span class="stringliteral">"timers"</span>, buff, got) == 0) {
            <a class="code" href="struct__NUTTIMERINFO.html">NUTTIMERINFO</a> *tnp;

            <a class="code" href="group__xgCrtStdio.html#ga23">fputs_P</a>(timer_intro_P, stream);
            <span class="keywordflow">for</span> (tnp = <a name="a336"></a><a class="code" href="group__xgTimer.html#ga0">nutTimerList</a>; tnp; tnp = tnp-&gt;<a name="a337"></a><a class="code" href="struct__NUTTIMERINFO.html#o0">tn_next</a>) {
                <a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(stream, <span class="stringliteral">"%lu\t"</span>, tnp-&gt;<a class="code" href="struct__NUTTIMERINFO.html#o3">tn_ticks_left</a>);
                <span class="keywordflow">if</span> (tnp-&gt;<a name="a338"></a><a class="code" href="struct__NUTTIMERINFO.html#o2">tn_ticks</a>)
                    <a class="code" href="group__xgCrtStdio.html#ga18">fprintf</a>(stream, <span class="stringliteral">"%lu\r\n"</span>, tnp-&gt;<a class="code" href="struct__NUTTIMERINFO.html#o2">tn_ticks</a>);
                <span class="keywordflow">else</span>
                    <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">"Oneshot\r\n"</span>, stream);
            }
            <a class="code" href="group__xgCrtStdio.html#ga22">fputs</a>(<span class="stringliteral">".\r\n"</span>, stream);
            <span class="keywordflow">continue</span>;
        }

        <span class="comment">/*</span>
<span class="comment">         * Quit connection.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a class="code" href="group__xgCrtString.html#ga16">strncmp</a>(<span class="stringliteral">"quit"</span>, buff, got) == 0) {
            <span class="keywordflow">break</span>;
        }

        <span class="comment">/*</span>
<span class="comment">         * Display help text on any unknown command.</span>
<span class="comment">         */</span>
        <a class="code" href="group__xgCrtStdio.html#ga23">fputs_P</a>(help_P, stream);
    }
}

<span class="comment">/*</span>
<span class="comment"> * PPP client application entry.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> pppcom;
    <a name="_a339"></a><a class="code" href="struct__PPPDCB.html">PPPDCB</a> *dcb;
    <a class="code" href="group__xgNutOS.html#ga3">u_long</a> lctl;
    <span class="keywordtype">int</span> rc;

    <span class="comment">/*</span>
<span class="comment">     * Register our devices.</span>
<span class="comment">     */</span>
<span class="preprocessor">#ifdef __AVR_ENHANCED__</span>
<span class="preprocessor"></span>    <a name="a340"></a><a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;DBGDEV, 0, 0);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef PPPDEV</span>
<span class="preprocessor"></span>    <a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;PPPDEV, 0, 0);
    <a class="code" href="group__xgDevice.html#ga7">NutRegisterDevice</a>(&amp;<a name="a341"></a><a class="code" href="group__xgPPP.html#ga1">devPpp</a>, 0, 0);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">/*</span>
<span class="comment">     * Open debug device for standard output.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span>(<a name="a342"></a><a class="code" href="group__xgCrtStdio.html#ga25">freopen</a>(<span class="stringliteral">"uart1"</span>, <span class="stringliteral">"w"</span>, <a name="a343"></a><a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>) == 0) {
        <span class="keywordflow">for</span>(;;);
    }

    <span class="comment">/*</span>
<span class="comment">     * Set debug output speed.</span>
<span class="comment">     */</span>
<span class="preprocessor">#ifdef __AVR_ENHANCED__</span>
<span class="preprocessor"></span>    lctl = DBGSPEED;
    <a name="a344"></a><a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(<a name="a345"></a><a class="code" href="group__xgCrtStdio.html#ga14">_fileno</a>(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>), <a name="a346"></a><a class="code" href="group__xgUARTIOCTL.html#ga0">UART_SETSPEED</a>, &amp;lctl);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">/*</span>
<span class="comment">     * Display banner including compiler info and Nut/OS version.</span>
<span class="comment">     */</span>
    <a name="a347"></a><a class="code" href="group__xgCrtStdio.html#ga37">printf_P</a>(vbanner_P, <a name="a348"></a><a class="code" href="group__xgNutVersion.html#ga1">NutVersionString</a>());

    <span class="comment">/*</span>
<span class="comment">     * Open PPP device. Specify physical device, user and password.</span>
<span class="comment">     */</span>
    <a name="a349"></a><a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Open uart..."</span>);
    <span class="keywordflow">if</span> ((pppcom = <a name="a350"></a><a class="code" href="group__xgCrtLowio.html#ga3">_open</a>(<span class="stringliteral">"ppp:"</span> PPPCOM <span class="stringliteral">"/"</span> PPPUSER <span class="stringliteral">"/"</span> PPPPASS, <a name="a351"></a><a class="code" href="group__xgCrtLowio.html#ga11">_O_RDWR</a> | <a name="a352"></a><a class="code" href="group__xgCrtLowio.html#ga17">_O_BINARY</a>)) == -1) {
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Failed to open "</span> PPPCOM <span class="stringliteral">"\n"</span>);
        <span class="keywordflow">for</span> (;;);
    }
    <a name="a353"></a><a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"done"</span>);

<span class="preprocessor">#ifdef PPPDEV</span>
<span class="preprocessor"></span>    <span class="comment">/*</span>
<span class="comment">     * Set PPP line speed.</span>
<span class="comment">     */</span>
    lctl = PPPSPEED;
    <a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(pppcom, <a class="code" href="group__xgUARTIOCTL.html#ga0">UART_SETSPEED</a>, &amp;lctl);

    <span class="comment">/*</span>
<span class="comment">     * The PPP driver doesn't set any receive timeout, but</span>
<span class="comment">     * may require it.</span>
<span class="comment">     */</span>
    lctl = PPPRXTO;
    <a class="code" href="group__xgCrtLowio.html#ga2">_ioctl</a>(pppcom, <a name="a354"></a><a class="code" href="group__xgUARTIOCTL.html#ga10">UART_SETREADTIMEOUT</a>, &amp;lctl);

<span class="preprocessor">#ifdef NUTDEBUG</span>
<span class="preprocessor"></span>    <span class="comment">/*</span>
<span class="comment">     * Optionally enable PPP trace.</span>
<span class="comment">     */</span>
    NutTracePPP(<a class="code" href="group__xgCrtStdio.html#ga66">stdout</a>, 1);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">/*</span>
<span class="comment">     * This delay may be removed. It is quite helpful during development.</span>
<span class="comment">     */</span>
    <a name="a355"></a><a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(5000);

    <span class="comment">/*</span>
<span class="comment">     * PPP connection loop.</span>
<span class="comment">     */</span>
    <span class="keywordflow">for</span> (;;) {
        <span class="comment">/*</span>
<span class="comment">         * Connect using a chat script. We may also set any</span>
<span class="comment">         * required hardware handshake line at this stage.</span>
<span class="comment">         */</span>
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Connecting..."</span>);
        <span class="keywordflow">if</span> ((rc = NutChat(pppcom, PPPCHAT)) != 0) {
            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"no connect, reason = %d\n"</span>, rc);
            <span class="keywordflow">continue</span>;
        }
        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"done"</span>);

        <span class="comment">/*</span>
<span class="comment">         * We are connected, configure our PPP network interface.</span>
<span class="comment">         * This will initiate the PPP configuration negotiation</span>
<span class="comment">         * and authentication with the server.</span>
<span class="comment">         */</span>
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Configure PPP..."</span>);
        rc = <a name="a356"></a><a class="code" href="group__xgIP.html#ga6">NutNetIfConfig</a>(<span class="stringliteral">"ppp"</span>, 0, 0, 0);
        <span class="keywordflow">if</span> (rc != 0) {
            <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"failed"</span>);
            <span class="comment">/*</span>
<span class="comment">             * Optionally toggle DTR to hang up the modem.</span>
<span class="comment">             */</span>
            <span class="keywordflow">continue</span>;
        }
        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"done"</span>);

        <span class="comment">/*</span>
<span class="comment">         * Set name server and default route. Actually the PPP interface</span>
<span class="comment">         * should do this, but the current release doesn't.</span>
<span class="comment">         */</span>
        dcb = <a class="code" href="group__xgPPP.html#ga1">devPpp</a>.<a name="a357"></a><a class="code" href="struct__NUTDEVICE.html#o6">dev_dcb</a>;
        <a name="a358"></a><a class="code" href="group__xgDNS.html#ga21">NutDnsConfig2</a>(0, 0, dcb-&gt;<a name="a359"></a><a class="code" href="struct__PPPDCB.html#o18">dcb_ip_dns1</a>, dcb-&gt;<a name="a360"></a><a class="code" href="struct__PPPDCB.html#o19">dcb_ip_dns2</a>);
        <a name="a361"></a><a class="code" href="group__xgIP.html#ga16">NutIpRouteAdd</a>(0, 0, dcb-&gt;<a name="a362"></a><a class="code" href="struct__PPPDCB.html#o16">dcb_remote_ip</a>, &amp;<a class="code" href="group__xgPPP.html#ga1">devPpp</a>);

        <span class="comment">/*</span>
<span class="comment">         * Display our IP settings.</span>
<span class="comment">         */</span>
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"     Local IP: %s\n"</span>, <a name="a363"></a><a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(dcb-&gt;<a name="a364"></a><a class="code" href="struct__PPPDCB.html#o15">dcb_local_ip</a>));
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"    Remote IP: %s\n"</span>, <a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(dcb-&gt;<a class="code" href="struct__PPPDCB.html#o16">dcb_remote_ip</a>));
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"  Primary DNS: %s\n"</span>, <a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(dcb-&gt;<a class="code" href="struct__PPPDCB.html#o18">dcb_ip_dns1</a>));
        <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Secondary DNS: %s\n"</span>, <a class="code" href="group__xgIP.html#ga9">inet_ntoa</a>(dcb-&gt;<a class="code" href="struct__PPPDCB.html#o19">dcb_ip_dns2</a>));

        <span class="comment">/*</span>
<span class="comment">         * Client connection loop.</span>
<span class="comment">         */</span>
        <span class="keywordflow">for</span> (;;) {
            <a name="_a365"></a><a class="code" href="structtcp__socket.html">TCPSOCKET</a> *sock;
            <a class="code" href="group__xgCrtStdio.html#ga0">FILE</a> *stream;

            <span class="comment">/*</span>
<span class="comment">             * Create a socket.</span>
<span class="comment">             */</span>
            <span class="keywordflow">if</span> ((sock = <a name="a366"></a><a class="code" href="group__xgTcpSocket.html#ga7">NutTcpCreateSocket</a>()) != 0) {

                <span class="comment">/*</span>
<span class="comment">                 * Listen on port 23. If we return, we got a client.</span>
<span class="comment">                 */</span>
                <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"Waiting for a client..."</span>);
                <span class="keywordflow">if</span> (<a name="a367"></a><a class="code" href="group__xgTcpSocket.html#ga11">NutTcpAccept</a>(sock, 23) == 0) {
                    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"connected"</span>);

                    <span class="comment">/*</span>
<span class="comment">                     * Open a stream and associate it with the socket, so</span>
<span class="comment">                     * we can use standard I/O. Note, that socket streams</span>
<span class="comment">                     * currently do support text mode.</span>
<span class="comment">                     */</span>
                    <span class="keywordflow">if</span> ((stream = <a name="a368"></a><a class="code" href="group__xgCrtStdio.html#ga8">_fdopen</a>((<span class="keywordtype">int</span>) sock, <span class="stringliteral">"r+b"</span>)) != 0) {
                        <span class="comment">/*</span>
<span class="comment">                         * Process client requests.</span>
<span class="comment">                         */</span>
                        ProcessRequests(stream);
                        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"\nDisconnected"</span>);

                        <span class="comment">/*</span>
<span class="comment">                         * Close the stream.</span>
<span class="comment">                         */</span>
                        <a name="a369"></a><a class="code" href="group__xgCrtStdio.html#ga6">fclose</a>(stream);
                    } <span class="keywordflow">else</span> {
                        <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"Assigning a stream failed"</span>);
                    }
                } <span class="keywordflow">else</span> {
                    <a class="code" href="group__xgCrtStdio.html#ga42">puts</a>(<span class="stringliteral">"failed"</span>);
                }

                <span class="comment">/*</span>
<span class="comment">                 * Close our socket.</span>
<span class="comment">                 */</span>
                <a name="a370"></a><a class="code" href="group__xgTcpSocket.html#ga14">NutTcpCloseSocket</a>(sock);
            }
            <a class="code" href="group__xgTimer.html#ga10">NutSleep</a>(1000);
            <a class="code" href="group__xgCrtStdio.html#ga36">printf</a>(<span class="stringliteral">"%u bytes free\n"</span>, <a class="code" href="group__xgHeap.html#ga8">NutHeapAvailable</a>());
        }
    }
<span class="preprocessor">#endif </span><span class="comment">/* PPPDEV */</span>
}
</pre></div> <hr>
<address>
  <small>
    &copy;&nbsp;2000-2006 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
